<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
  <link rel="icon" href="assets/logo.png" type="image/png">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BIGTAC ‚Äì Tacos & Grill</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kaushan+Script&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Outfit', 'sans-serif'],
            script: ['Kaushan Script', 'cursive'],
          },
          colors: {
            primary: '#ea580c', /* Burnt Orange from Menu */
            secondary: '#1e293b',
            surface: '#ffffff',
            background: '#f8fafc',
          },
          animation: {
            'float': 'float 6s ease-in-out infinite',
            'scale-in': 'scaleIn 0.2s ease-out forwards',
            'slide-out-left': 'slideOutLeft 0.2s ease-out forwards',
            'slide-out-right': 'slideOutRight 0.2s ease-out forwards',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-20px)' },
            },
            scaleIn: {
              '0%': { transform: 'scale(0.9)', opacity: '0' },
              '100%': { transform: 'scale(1)', opacity: '1' },
            },
            slideOutLeft: {
              '0%': { transform: 'translateX(0)', opacity: '1' },
              '100%': { transform: 'translateX(-20px)', opacity: '0' },
            },
            slideOutRight: {
              '0%': { transform: 'translateX(0)', opacity: '1' },
              '100%': { transform: 'translateX(20px)', opacity: '0' },
            }
          }
        }
      }
    }
  </script>

  <style>
    /* --- CUSTOM STYLES --- */
    body { 
      background-color: #f8fafc; 
      color: #334155; 
      -webkit-tap-highlight-color: transparent;
      transition: background-color 0.3s, color 0.3s;
    }
    
    .dark body {
      background-color: #0f172a;
      color: #e2e8f0;
    }
    
    /* Scroll Reveal Animation Classes */
    .reveal {
        opacity: 0;
        transform: translateY(30px);
        transition: all 0.8s cubic-bezier(0.5, 0, 0, 1);
    }
    
    .reveal.active {
        opacity: 1;
        transform: translateY(0);
    }

    /* Immediate Fade In for Dynamic Content */
    .fade-in-immediate {
        animation: fadeInUp 0.6s ease-out forwards;
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Glassmorphism */
    .glass {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.3);
    }
    
    .dark .glass {
      background: rgba(15, 23, 42, 0.85);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .hero-section {
        background-image: linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0.9)), url('assets/snack.png');
        background-size: cover; 
        background-position: center; 
        min-height: 85vh;
        display: flex; 
        align-items: center; 
        justify-content: center; 
        position: relative;
        background-attachment: scroll; 
    }

    @media (min-width: 1024px) {
        .hero-section {
            background-attachment: fixed;
        }
    }

    /* Card Hover Effects */
    .menu-card {
        background: white;
        border-radius: 1.5rem;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 1px solid #f1f5f9;
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
    }
    
    .dark .menu-card {
        background: #1e293b;
        border-color: #334155;
    }

    .menu-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px -12px rgba(234, 88, 12, 0.15);
        border-color: #fb923c;
    }
    
    .dark .menu-card:hover {
        border-color: #ea580c;
    }
    
    .menu-card-image {
        width: 100%;
        height: 240px;
        object-fit: cover;
        transition: transform 0.7s ease;
    }
    .menu-card:hover .menu-card-image {
        transform: scale(1.1);
    }
    
    .menu-card-content {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }
    
    .menu-card-price-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
        padding-top: 1rem;
    }

    .add-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        background: #fff7ed;
        color: #ea580c;
        border: 2px solid #fdba74;
    }
    
    .dark .add-btn {
        background: #ea580c20;
        border-color: #ea580c;
    }

    .menu-card:hover .add-btn {
        background: #ea580c;
        color: white;
        border-color: #ea580c;
        transform: rotate(90deg) scale(1.1);
    }
    
    .add-btn:active {
        transform: scale(0.9);
    }

    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .filter-scroll { 
        display: flex; 
        gap: 0.75rem; 
        overflow-x: auto; 
        padding: 1.5rem 0; 
        scrollbar-width: none; 
    }

    .filter-btn {
        transition: all 0.3s ease;
        white-space: nowrap;
        border-radius: 9999px;
    }
    .filter-btn.active {
        background-color: #ea580c;
        color: white;
        box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        transform: scale(1.05);
    }
    
    .filter-btn-image {
        position: relative; 
        color: white !important; 
        border: 3px solid transparent; 
        background-size: cover; 
        background-position: center;
        background-clip: padding-box; 
        text-shadow: 0 1px 3px rgba(0,0,0,0.9); 
        overflow: hidden;
        transform: none !important; 
        transition: all 0.2s ease-in-out;
        border-radius: 9999px;
        min-width: auto;
        padding-left: 1.5rem;
        padding-right: 1.5rem;
        flex-shrink: 0;
    }
    .filter-btn-image::before {
        content: ""; position: absolute; inset: 0;
        background: rgba(0,0,0,0.4);
        transition: background 0.2s;
    }
    .filter-btn-image.active {
        border-color: #ea580c !important;
        box-shadow: 0 4px 12px rgba(234, 88, 12, 0.4);
        transform: translateY(-2px) !important;
    }
    .filter-btn-image span { position: relative; z-index: 10; white-space: nowrap; }

    .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #ea580c;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    .dark .loader {
        border-color: #334155;
        border-top-color: #ea580c;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .tracker-visible { transform: translateY(0) !important; }
    
    /* Interactive Elements */
    button, a {
        cursor: pointer;
    }
    button:active, a.btn-active:active {
        transform: scale(0.96) !important;
    }

    /* WIZARD SPECIFIC STYLES */
    .wizard-step-container { display: none; }
    .wizard-step-container.active { display: block; }
    
    .size-card.selected {
        border-color: #ea580c;
        background-color: #fff7ed;
        box-shadow: 0 4px 12px rgba(234, 88, 12, 0.2);
    }
    .dark .size-card.selected {
        background-color: rgba(234, 88, 12, 0.2);
        border-color: #ea580c;
    }
    
    .option-card { transition: all 0.2s; }
    .option-card.selected {
        border-color: #ea580c;
        background-color: #ffedd5;
    }
    .dark .option-card.selected {
        background-color: rgba(234, 88, 12, 0.15);
        border-color: #ea580c;
    }
  </style>
</head>

<body class="font-sans text-slate-800 dark:text-slate-100 bg-slate-50 dark:bg-slate-900 pb-24 selection:bg-orange-100 selection:text-orange-900">

    <header class="glass fixed top-0 w-full z-50 transition-all duration-300 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
          <a href="#" class="flex items-center gap-3 group">
              <div class="relative">
                  <div class="absolute inset-0 bg-orange-500 blur-lg opacity-20 group-hover:opacity-40 transition rounded-full"></div>
                  <!-- Use LOGO here -->
                
                <div class="h-12 w-12 bg-black rounded-full flex items-center justify-center border-2 border-orange-500 relative z-10 transform group-hover:scale-110 transition duration-300 overflow-hidden">
                    <img src="assets/logo.png" alt="Logo" class="w-full h-full object-cover">
                </div>
            
              </div>
              <div class="flex flex-col">
                  <span class="text-2xl font-bold font-script text-slate-800 dark:text-white leading-none tracking-wide">BIGTAC</span>
                  <span class="text-[10px] text-orange-600 font-bold uppercase tracking-widest">Tacos & Grill</span>
              </div>
          </a>
          <nav class="hidden md:flex items-center gap-8 font-medium text-slate-500 dark:text-slate-400">
            <a href="#hero" class="hover:text-orange-600 transition">Accueil</a>
            <a href="#promotions" class="hover:text-orange-600 transition">Offres</a>
            <a href="#menu-unified" class="hover:text-orange-600 transition">Menu</a>
          </nav>
          <div class="flex items-center gap-3">
              <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 transition">
                  <svg id="icon-moon" class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                  <svg id="icon-sun" class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
              </button>
              <button onclick="openCart()" id="btnNavCart" class="relative group flex items-center gap-2 bg-slate-100 dark:bg-slate-800 hover:bg-orange-50 dark:hover:bg-slate-700 text-slate-800 dark:text-white px-4 py-2.5 rounded-full transition-all duration-300 border border-transparent hover:border-orange-200 dark:hover:border-slate-600 active:scale-95">
                  <div class="relative">
                      <svg class="w-5 h-5 text-slate-700 dark:text-slate-300 group-hover:text-orange-600 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                      <span id="navCartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full shadow-sm hidden transform scale-0 transition-transform duration-300">0</span>
                  </div>
                  <span class="text-sm font-bold hidden sm:block">Panier</span>
              </button>
          </div>
        </div>
      </div>
    </header>
  
    <section id="hero" class="hero-section">
      <div class="absolute inset-0 bg-gradient-to-b from-black/50 via-black/20 to-slate-900/90 dark:to-slate-950/95"></div>
      <div class="relative z-10 text-center px-4 max-w-4xl mx-auto pt-16 reveal active">
        <!-- BIGTAC LOGO PLACEHOLDER -->
        <<div class="h-12 w-12 bg-black rounded-full flex items-center justify-center border-2 border-orange-500 relative z-10 transform group-hover:scale-110 transition duration-300 overflow-hidden">
            <img src="assets/logo.png" alt="Logo" class="w-full h-full object-cover">
        </div>
        
        
        <h1 class="text-5xl md:text-7xl font-bold mb-6 text-white font-script drop-shadow-lg leading-tight">BIGTAC <br><span class="text-orange-500">Tacos & Grill</span></h1>
        <p class="text-lg md:text-2xl text-slate-200 mb-10 font-light tracking-wide max-w-2xl mx-auto">Le go√ªt authentique, directement chez vous.</p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
          <a href="#menu-unified" class="px-8 py-4 bg-orange-600 hover:bg-orange-700 text-white rounded-full font-bold text-lg transition-all shadow-lg transform hover:-translate-y-1 w-full sm:w-auto btn-active">Commander</a>
          <a href="#locations" class="px-8 py-4 bg-white/10 hover:bg-white/20 backdrop-blur-md text-white border border-white/30 rounded-full font-bold text-lg transition-all hover:border-white/60 w-full sm:w-auto btn-active">Nous Trouver</a>
        </div>
      </div>
    </section>
  
    <section id="promotions" class="py-10 bg-white dark:bg-slate-900 hidden border-b border-slate-100 dark:border-slate-800">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center gap-3 mb-6">
               <div class="bg-red-100 p-2 rounded-full"><svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path></svg></div>
               <h2 class="text-3xl font-bold text-slate-900 dark:text-white font-script">Offres Sp√©ciales</h2>
          </div>
          <div id="promotionsGrid" class="flex gap-6 overflow-x-auto pb-4 hide-scrollbar snap-x">
              </div>
      </div>
    </section>
  
    <section id="popular" class="py-10 bg-slate-50 dark:bg-slate-800 hidden">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center gap-3 mb-6">
               <div class="bg-orange-100 p-2 rounded-full"><svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg></div>
               <h2 class="text-3xl font-bold text-slate-900 dark:text-white font-script">Les Plus Populaires</h2>
          </div>
          <div id="popularGrid" class="flex gap-6 overflow-x-auto pb-4 hide-scrollbar snap-x">
               </div>
      </div>
    </section>
  
    <section id="menu-unified" class="py-16 bg-white dark:bg-slate-900 min-h-screen relative">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center max-w-2xl mx-auto mb-12">
          <h2 class="text-4xl md:text-5xl font-bold text-slate-900 dark:text-white mb-4 font-script">Notre Carte</h2>
          <p class="text-lg text-slate-600 dark:text-slate-400">Tacos, Burgers, et bien plus encore.</p>
        </div>
        <div class="max-w-xl mx-auto mb-10 relative group z-30">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <svg class="h-6 w-6 text-slate-400 dark:text-slate-500 group-focus-within:text-orange-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
          <input type="text" id="menuSearch" placeholder="Rechercher (Tacos, Nuggets...)" class="block w-full pl-12 pr-4 py-4 bg-slate-50 dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-2xl leading-5 placeholder-slate-400 focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm text-lg dark:text-white">
        </div>
        <div class="sticky top-20 z-30 py-4 -mx-4 px-4 bg-white/95 dark:bg-slate-900/95 backdrop-blur transition-all" id="stickyFilterBar">
          <div class="filter-scroll flex gap-3 overflow-x-auto hide-scrollbar max-w-7xl mx-auto pb-2" id="categoryFilters"></div>
        </div>
        <div id="menuContent" class="mt-8 min-h-[400px]">
          <div class="flex justify-center py-20"><div class="loader"></div></div>
        </div>
      </div>
    </section>

  <section id="locations" class="py-20 bg-slate-900 dark:bg-slate-950 text-white relative overflow-hidden">
    <div class="max-w-7xl mx-auto px-4 relative z-10">
      <div class="grid lg:grid-cols-2 gap-12 items-center">
        <div class="space-y-8">
          <div>
              <h2 class="text-4xl md:text-5xl font-bold mb-4 font-script text-orange-500">BIGTAC</h2>
              <p class="text-xl text-slate-300">Fast Food de qualit√© √† F√®s.</p>
          </div>
          <div class="bg-white/5 backdrop-blur-lg border border-white/10 rounded-3xl p-6 hover:bg-white/10 transition">
            <div class="flex items-start gap-4">
                <div class="bg-orange-500/20 p-3 rounded-xl text-orange-500 flex-shrink-0">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-white">Adresse</h3>
                    <p class="text-slate-300 text-sm">2XQV+VJ5, Rue Abdelkrim Benjelloun, F√®s 30050</p>
                    <a href="https://maps.app.goo.gl/MpyAC424WpXYfEAw8" target="_blank" class="text-orange-400 text-sm font-bold hover:underline mt-1 inline-block">Voir Carte</a>
                </div>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
             <button onclick="contactWhatsApp()" class="flex items-center justify-center gap-3 bg-[#25D366] hover:bg-[#20bd5a] text-white py-4 rounded-2xl font-bold transition shadow-lg hover:shadow-[#25D366]/30 active:scale-95">WhatsApp</button>
             <button onclick="contactCall()" class="flex items-center justify-center gap-3 bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-2xl font-bold transition shadow-lg hover:shadow-blue-600/30 active:scale-95">Appeler</button>
          </div>
        </div>
      </div>
      <div class="border-t border-slate-800 mt-16 pt-8 flex flex-col md:flex-row justify-between items-center gap-4 text-slate-400 text-sm">
        <p>¬© 2025 BIGTAC. <span>Tous droits r√©serv√©s.</span></p>
        <a href="https://www.instagram.com/thebigtac_01/" target="_blank" class="flex items-center gap-2 hover:text-white transition">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
            <span class="font-bold tracking-wide">Instagram</span>
        </a>
      </div>
    </div>
  </section>

  <div id="orderTracker" class="fixed bottom-0 left-0 w-full bg-white dark:bg-slate-800 shadow-[0_-4px_20px_rgba(0,0,0,0.1)] z-50 transform translate-y-full transition-transform duration-300 hidden">
      <div class="max-w-2xl mx-auto p-4 flex items-center justify-between gap-4">
          <div class="flex items-center gap-4 flex-1">
              <div id="trackerIcon" class="w-12 h-12 rounded-full flex items-center justify-center text-white bg-yellow-500 shadow-md animate-pulse"></div>
              <div>
                  <div class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wide">Votre commande <span id="trackerId" class="text-slate-800 dark:text-white"></span></div>
                  <div id="trackerStatus" class="font-bold text-slate-800 dark:text-white text-lg leading-tight">En attente...</div>
              </div>
          </div>
          <button onclick="closeTracker()" class="p-2 bg-slate-100 dark:bg-slate-700 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-500 dark:text-slate-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
      </div>
      <div id="trackerBar" class="h-1 bg-yellow-500 w-full transition-colors duration-500"></div>
  </div>

  <button onclick="openCart()" id="fabCart" class="fixed bottom-6 right-6 bg-orange-500 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center z-40 transform scale-0 transition-transform duration-300 hover:scale-110 active:scale-95 border-4 border-white dark:border-slate-800 hover:bg-orange-600">
      <div class="relative">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
          <span id="fabCount" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full shadow-sm">0</span>
      </div>
  </button>

  <!-- WIZARD ITEM MODAL -->
  <div id="addItemModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity opacity-0" onclick="closeAddItemModal()"></div>
    
    <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-3xl shadow-2xl transform transition-all duration-300 scale-95 opacity-0 pointer-events-auto overflow-hidden flex flex-col max-h-[90vh] relative z-10">
        <!-- Progress Bar (Visible only for Wizard) -->
        <div id="wizardProgress" class="hidden h-1.5 bg-slate-100 dark:bg-slate-700 w-full">
            <div id="wizardProgressBar" class="h-full bg-orange-500 transition-all duration-500" style="width: 0%"></div>
        </div>

        <!-- Header with Image (Collapsed in Wizard) -->
        <div id="modalHeader" class="relative flex-shrink-0 transition-all duration-300 h-48 sm:h-56">
            <img id="modalItemImage" src="" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
            <button onclick="closeAddItemModal()" class="absolute top-4 right-4 bg-black/20 hover:bg-black/40 text-white p-2 rounded-full backdrop-blur-md transition z-20">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="absolute bottom-4 left-6 right-6">
                <h3 id="modalItemName" class="text-2xl font-bold text-white leading-tight shadow-black drop-shadow-md"></h3>
                <p id="modalItemBasePrice" class="text-orange-400 font-bold text-lg"></p>
            </div>
        </div>

        <!-- Content Area -->
        <div id="modalContent" class="flex-1 overflow-y-auto p-6 space-y-6 bg-white dark:bg-slate-800 relative">
            <p id="modalItemDesc" class="text-slate-500 dark:text-slate-400 text-sm leading-relaxed mb-4"></p>
            
            <!-- Wizard Step Container -->
            <div id="wizardContainer"></div>
        </div>

        <!-- Footer Actions -->
        <div class="p-5 bg-white dark:bg-slate-800 border-t border-slate-100 dark:border-slate-700 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-10 flex flex-col gap-3">
            
            <!-- Wizard Navigation -->
            <div id="wizardNav" class="hidden flex gap-3">
                <button onclick="handleWizardAction('prev')" id="btnWizardPrev" class="px-6 py-3 rounded-xl font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600 transition">Retour</button>
                <button onclick="handleWizardAction('next')" id="btnWizardNext" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-orange-200 dark:shadow-none transition disabled:opacity-50 disabled:cursor-not-allowed">Suivant</button>
            </div>

            <!-- Simple Add Action -->
            <div id="simpleNav" class="flex items-center gap-4">
                <div class="flex items-center bg-slate-100 dark:bg-slate-700 rounded-full p-1">
                    <button onclick="updateModalQty(-1)" class="w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-slate-600 text-slate-600 dark:text-slate-200 shadow-sm hover:bg-slate-50 dark:hover:bg-slate-500 font-bold text-lg transition active:scale-90">-</button>
                    <span id="modalQtyDisplay" class="w-10 text-center font-bold text-slate-800 dark:text-white">1</span>
                    <button onclick="updateModalQty(1)" class="w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-slate-600 text-orange-600 dark:text-orange-400 shadow-sm hover:bg-orange-50 dark:hover:bg-slate-500 font-bold text-lg transition active:scale-90">+</button>
                </div>
                <button onclick="addToCartFromModal()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-2 px-2 rounded-xl font-bold text-lg shadow-lg shadow-orange-200 dark:shadow-none transition active:scale-95 flex flex-wrap justify-center items-center gap-x-3 gap-y-0 min-h-[50px]">
                    <span data-key="btn_add">Ajouter</span>
                    <span id="modalTotalPriceDisplay" class="bg-white/20 px-3 py-1 rounded-lg text-sm font-bold whitespace-nowrap mt-0.5 mb-0.5"></span>
                </button>
            </div>
        </div>
    </div>
  </div>

  <div id="cartModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeCart()"></div>
    <div class="absolute top-0 right-0 w-full max-w-md h-full bg-white dark:bg-slate-800 shadow-2xl transform transition-transform duration-300 translate-x-full flex flex-col">
      <div class="p-5 border-b flex justify-between items-center bg-slate-50 dark:bg-slate-900 border-slate-100 dark:border-slate-700">
        <h3 class="text-xl font-bold text-slate-800 dark:text-white">Votre Panier</h3>
        <button onclick="closeCart()" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition"><svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
      </div>
      <div id="cartItemsContainer" class="flex-1 overflow-y-auto p-5 space-y-4"></div>
      <div class="p-6 border-t bg-slate-50 dark:bg-slate-900 border-slate-100 dark:border-slate-700 space-y-4">
        <div class="flex justify-between text-xl font-bold text-slate-800 dark:text-white"><span>Total</span><span id="cartFinalTotal" class="text-orange-600 dark:text-orange-400">0 Dh</span></div>
        <button onclick="openCheckoutModal()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg transition transform active:scale-95">Commander</button>
      </div>
    </div>
  </div>

  <div id="nameModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModalAnimation('nameModal')"></div>
    <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 w-full max-w-sm relative z-10 shadow-2xl transform transition-all duration-300 scale-95 opacity-0">
        <div class="flex justify-center mb-6">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold text-sm">1</div>
                <div class="w-8 h-1 bg-slate-200 dark:bg-slate-600"></div>
                <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-600 text-slate-400 flex items-center justify-center font-bold text-sm">2</div>
                <div class="w-8 h-1 bg-slate-200 dark:bg-slate-600"></div>
                <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-600 text-slate-400 flex items-center justify-center font-bold text-sm">3</div>
            </div>
        </div>
        <h3 class="text-2xl font-bold text-center mb-2 text-slate-800 dark:text-white">Vos Coordonn√©es</h3>
        <p class="text-center text-slate-500 dark:text-slate-400 mb-6 text-sm">Pour valider votre commande</p>
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1 ml-1">Nom Complet</label>
                <input type="text" id="customerName" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 transition dark:text-white" placeholder="Votre Nom">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1 ml-1">T√©l√©phone </label>
                <input type="tel" id="customerPhone" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 transition dark:text-white" placeholder="06... / 07... / 05...">
                <p id="phoneError" class="text-red-500 text-xs mt-1 hidden">Veuillez entrer un num√©ro valide</p>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1 ml-1">Note (Optionnel)</label>
                <textarea id="customerNote" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 transition resize-none dark:text-white" rows="3" placeholder="Allergies, sans oignon, etc."></textarea>
            </div>
            <button onclick="nextCheckoutStep()" class="w-full bg-orange-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-orange-100 dark:shadow-none mt-2 active:scale-95 transition">Suivant</button>
        </div>
    </div>
  </div>

  <!-- SERVICE MODAL -->
  <div id="serviceModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModalAnimation('serviceModal')"></div>
      <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 w-full max-w-sm relative z-10 shadow-2xl transform transition-all duration-300 scale-95 opacity-0 flex flex-col">
          <div class="flex justify-center mb-6">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold text-sm">‚úì</div>
                <div class="w-8 h-1 bg-orange-500"></div>
                <div class="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold text-sm">2</div>
                <div class="w-8 h-1 bg-slate-200 dark:bg-slate-600"></div>
                <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-600 text-slate-400 flex items-center justify-center font-bold text-sm">3</div>
            </div>
        </div>
          <h3 class="text-2xl font-bold text-center mb-2 text-slate-800 dark:text-white">Service</h3>
          <p class="text-center text-slate-500 dark:text-slate-400 mb-6 text-sm">Mode de commande</p>
          <div class="space-y-2">
              <button onclick="selectService('sur_place')" class="w-full text-left p-3 border-2 border-slate-200 dark:border-slate-600 rounded-xl hover:border-orange-500 hover:bg-orange-50 dark:hover:bg-slate-700 transition flex items-center gap-3">
                  <span class="bg-slate-100 p-2 rounded-lg">üçΩÔ∏è</span>
                  <div>
                      <div class="font-bold text-slate-800 dark:text-white">Sur Place</div>
                      <div class="text-xs text-slate-500">Manger au restaurant</div>
                  </div>
              </button>
              <button onclick="selectService('emporter')" class="w-full text-left p-3 border-2 border-slate-200 dark:border-slate-600 rounded-xl hover:border-orange-500 hover:bg-orange-50 dark:hover:bg-slate-700 transition flex items-center gap-3">
                  <span class="bg-slate-100 p-2 rounded-lg">ü•°</span>
                  <div>
                      <div class="font-bold text-slate-800 dark:text-white">A Emporter</div>
                      <div class="text-xs text-slate-500">R√©cup√©rer au comptoir</div>
                  </div>
              </button>
              <button onclick="selectService('livraison')" class="w-full text-left p-3 border-2 border-slate-200 dark:border-slate-600 rounded-xl hover:border-orange-500 hover:bg-orange-50 dark:hover:bg-slate-700 transition flex items-center gap-3">
                  <span class="bg-slate-100 p-2 rounded-lg">üõµ</span>
                  <div>
                      <div class="font-bold text-slate-800 dark:text-white">Livraison</div>
                      <div class="text-xs text-slate-500">√Ä partir de 4 DH</div>
                  </div>
              </button>
          </div>
          <button onclick="switchModal('serviceModal', 'nameModal')" class="w-full mt-6 text-slate-400 text-sm hover:text-slate-600 dark:hover:text-slate-200 transition">Retour</button>
      </div>
  </div>

  <!-- DELIVERY ZONES MODAL -->
  <div id="deliveryZoneModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModalAnimation('deliveryZoneModal')"></div>
      <div class="bg-white dark:bg-slate-800 rounded-3xl p-6 w-full max-w-md relative z-10 shadow-2xl transform transition-all duration-300 scale-95 opacity-0 flex flex-col max-h-[85vh]">
          <div class="flex justify-center mb-4 flex-none">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold text-sm">‚úì</div>
                <div class="w-8 h-1 bg-orange-500"></div>
                <div class="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold text-sm">2</div>
                <div class="w-8 h-1 bg-orange-500"></div>
                <div class="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold text-sm">3</div>
            </div>
        </div>
          <h3 class="text-2xl font-bold text-center mb-2 text-slate-800 dark:text-white">Zone de Livraison</h3>
          <p class="text-center text-slate-500 dark:text-slate-400 mb-4 text-sm">S√©lectionnez votre quartier</p>
          
          <div id="zoneList" class="space-y-2 overflow-y-auto flex-1 pr-1 pb-4">
              <!-- Zones injected by JS -->
          </div>

          <div class="pt-4 border-t border-slate-100 dark:border-slate-700 flex-none bg-white dark:bg-slate-800">
             <button onclick="confirmDeliveryZone()" id="btnConfirmZone" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition">Confirmer</button>
             <button onclick="switchModal('deliveryZoneModal', 'serviceModal')" class="w-full mt-3 text-slate-400 text-sm hover:text-slate-600 dark:hover:text-slate-200 transition">Retour</button>
          </div>
      </div>
  </div>

  <div id="summaryModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModalAnimation('summaryModal')"></div>
      <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 w-full max-w-sm relative z-10 shadow-2xl transform transition-all duration-300 scale-95 opacity-0 flex flex-col max-h-[80vh]">
          <div class="flex justify-center mb-6">
            <div class="flex items-center">
                 <div class="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold text-sm">‚úì</div>
                 <div class="w-8 h-1 bg-orange-500"></div>
                 <div class="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold text-sm">‚úì</div>
                 <div class="w-8 h-1 bg-orange-500"></div>
                 <div class="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold text-sm">‚úì</div>
            </div>
        </div>
          <h3 class="text-2xl font-bold text-center mb-4 text-slate-800 dark:text-white">R√©capitulatif</h3>
          <div class="flex-1 overflow-y-auto space-y-4 mb-6 pr-2">
              <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl border border-slate-100 dark:border-slate-600">
                  <div class="text-xs font-bold text-slate-400 uppercase mb-1">Client</div>
                  <div class="font-bold text-slate-800 dark:text-white" id="summaryName"></div>
                  <div class="text-sm text-slate-600 dark:text-slate-300" id="summaryPhone"></div>
              </div>
              <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl border border-slate-100 dark:border-slate-600">
                  <div class="text-xs font-bold text-slate-400 uppercase mb-1">D√©tails Commande</div>
                  <div class="font-bold text-slate-800 dark:text-white" id="summaryType"></div>
                  <div class="text-sm text-orange-600 font-semibold mt-1" id="summaryLocation"></div>
              </div>
              <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl border border-slate-100 dark:border-slate-600">
                  <div class="text-xs font-bold text-slate-400 uppercase mb-1">Contenu</div>
                  <div id="summaryItems" class="space-y-2 text-sm text-slate-600 dark:text-slate-300 border-b border-slate-200 pb-2 mb-2"></div>
                  <div id="summaryDeliveryFee" class="flex justify-between text-sm text-slate-600 dark:text-slate-400 hidden">
                      <span>Livraison</span>
                      <span id="deliveryPriceDisplay">0.00 Dh</span>
                  </div>
                  <div class="mt-2 flex justify-between font-bold text-slate-800 dark:text-white text-lg">
                      <span>Total</span>
                      <span id="summaryTotal"></span>
                  </div>
              </div>
          </div>
          <button id="btnFinalize" onclick="finalizeOrder()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-orange-100 dark:shadow-none transition transform active:scale-95">
              Confirmer la Commande
          </button>
          <button onclick="closeModalAnimation('summaryModal')" class="w-full mt-4 text-slate-400 text-sm hover:text-slate-600 dark:hover:text-slate-200 transition">Modifier</button>
      </div>
  </div>

  <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-3 z-50 transition-all duration-300 opacity-0 translate-y-10 pointer-events-none">
      <div class="bg-orange-500 rounded-full p-1"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
      <span class="font-bold text-sm">Ajout√© au panier !</span>
  </div>

  <script type="module">
    import { db, collection, getDocs, query, orderBy, addDoc, serverTimestamp, doc, onSnapshot, getDoc, runTransaction } from './firebase-config.js';

    // --- CONFIG & CONSTANTS ---
    const WHATSAPP_NUMBERS = {
        'default': '212663339105' 
    };
    
    // --- DELIVERY ZONES DATA ---
    const DELIVERY_ZONES = [
        { id: 1, price: 4, name: "Trajet 1", areas: "Centre ville, Champs de course, Atlas, Dekkarat" },
        { id: 2, price: 6, name: "Trajet 2", areas: "Hay lala soukaina, Adarissa, Saada, Lmerja, Boulevard med 6, Ennakhil, Mimousa, Hay tarik, Hay badr" },
        { id: 3, price: 8, name: "Trajet 3", areas: "OUED FES, HADIKA, AIN KADOUS, Bendbab, Zouagha, Bensouda" },
        { id: 4, price: 10, name: "Trajet 4", areas: "Route sefrou, Narjis, Fes shore, Mon fleurie, Route ain chkaf, Route imouzzer, Sidi brahim, EURO MED, CALIFORNIE, SIDI BOUJIDA, OLD MEDINA, BATHA, BAB FTOUH" },
        { id: 5, price: 20, name: "Trajet 5", areas: "OULAD TAYEB" }
    ];

    let appConfig = { isOpen: true, whatsappMode: false };

    // --- ANIMATION OBSERVER ---
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('active');
            }
        });
    }, { threshold: 0.1 });

    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

    // --- ANIMATION HELPERS ---
    window.openModalAnimation = (id) => {
        const modal = document.getElementById(id);
        modal.classList.remove('hidden');
        void modal.offsetWidth; // Trigger reflow
        
        const backdrop = modal.firstElementChild;
        const card = modal.lastElementChild;
        
        backdrop.classList.remove('opacity-0');
        if(card.classList.contains('translate-x-full')) {
            card.classList.remove('translate-x-full');
        } else {
            card.classList.remove('scale-95', 'opacity-0');
            card.classList.add('scale-100', 'opacity-100');
        }
    };

    window.closeModalAnimation = (id) => {
        const modal = document.getElementById(id);
        const backdrop = modal.firstElementChild;
        const card = modal.lastElementChild;
        
        backdrop.classList.add('opacity-0');
        if(card.classList.contains('flex-col') && card.classList.contains('absolute')) {
             card.classList.add('translate-x-full');
        } else {
             card.classList.remove('scale-100', 'opacity-100');
             card.classList.add('scale-95', 'opacity-0');
        }
        setTimeout(() => { modal.classList.add('hidden'); }, 300);
    };

    window.switchModal = (from, to) => {
        closeModalAnimation(from);
        setTimeout(() => openModalAnimation(to), 300);
    };

    // --- MAIN APP LOGIC ---
    let currentTheme = localStorage.getItem('bigtacTheme') || 'light';

    window.toggleDarkMode = () => {
        currentTheme = currentTheme === 'light' ? 'dark' : 'light';
        localStorage.setItem('bigtacTheme', currentTheme);
        updateThemeUI();
    };

    function updateThemeUI() {
        if (currentTheme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    }
    updateThemeUI();
    
    let allItems = [];
    let allPromotions = [];
    let allCategories = [];
    let categoryImages = {};
    let cart = JSON.parse(localStorage.getItem('bigtacCart') || '[]');
    let currentItem = null;
    let modalQty = 1;
    let wizardSteps = [];
    let currentStepIndex = 0;
    let wizardData = {}; 
    
    // Checkout State
    let checkoutData = { name: '', phone: '', note: '', type: '', location: '', deliveryPrice: 0 };
    let activeOrderUnsubscribe = null;
    let selectedZoneId = null;

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
        });
    });

    async function init() {
        if(typeof window.updateCartUI === 'function') window.updateCartUI();
        
        onSnapshot(doc(db, "settings", "config"), (doc) => {
            if(doc.exists()) {
                appConfig = doc.data();
            }
        });
        
        try {
            const pCategories = fetchCategories().catch(e => console.error("Category Fetch Error:", e));
            const pItems = fetchItems().catch(e => {
                console.error("Item Fetch Error:", e);
                const container = document.getElementById('menuContent');
                container.innerHTML = `<div class="flex flex-col items-center justify-center py-10 text-center">
                    <div class="bg-red-50 text-red-500 p-4 rounded-full mb-3"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    <p class="font-bold text-slate-700 dark:text-slate-300">Impossible de charger le menu</p>
                    <p class="text-sm text-slate-500">V√©rifiez votre connexion internet.</p>
                    <button onclick="location.reload()" class="mt-4 text-xs bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-full font-bold transition">R√©essayer</button>
                </div>`;
            });
            const pPromos = fetchPromotions().catch(e => console.error("Promo Fetch Error:", e));
            
            await Promise.all([pCategories, pItems, pPromos]);
        } catch (e) {
            console.error("Global Init Error:", e);
        }
        initOrderTracker();
        renderDeliveryZones();
    }

    // Add this variable OUTSIDE the function
    let lastStatus = null;

    function initOrderTracker() {
        const activeId = localStorage.getItem('activeOrderId'); 
        if(!activeId) return;
        
        if(activeOrderUnsubscribe) activeOrderUnsubscribe();
        
        const trackerEl = document.getElementById('orderTracker');
        const iconEl = document.getElementById('trackerIcon');
        const statusEl = document.getElementById('trackerStatus');
        const barEl = document.getElementById('trackerBar');
        const idEl = document.getElementById('trackerId');

        // Start listening
        activeOrderUnsubscribe = onSnapshot(doc(db, "orders", activeId), {
            next: (docSnap) => {
                if(!docSnap.exists()) { 
                    localStorage.removeItem('activeOrderId'); 
                    trackerEl.classList.add('hidden'); 
                    return; 
                }
                
                const data = docSnap.data();
                
                trackerEl.classList.remove('hidden'); 
                setTimeout(() => trackerEl.classList.add('tracker-visible'), 50);
                
                idEl.innerText = data.shortId ? `#${data.shortId}` : '';

                requestAnimationFrame(() => {
                    if (data.status === 'pending') {
                        statusEl.innerText = "En attente de confirmation...";
                        iconEl.className = "w-12 h-12 rounded-full flex items-center justify-center text-white bg-yellow-500 shadow-md animate-pulse";
                        barEl.className = "h-1 bg-yellow-500 w-full";
                        iconEl.innerHTML = `<i data-feather="clock"></i>`;
                    
                    } else if (data.status === 'confirmed') {
                        statusEl.innerText = "En pr√©paration cuisine...";
                        iconEl.className = "w-12 h-12 rounded-full flex items-center justify-center text-white bg-blue-500 shadow-md";
                        barEl.className = "h-1 bg-blue-500 w-full";
                        iconEl.innerHTML = `<i data-feather="loader" class="animate-spin"></i>`;
                        triggerNotification("Commande Confirm√©e ! üë®‚Äçüç≥", "C'est parti en cuisine !");
                    
                    } else if (data.status === 'en_livraison') {
                        statusEl.innerText = "Pr√™te/En livraison"; 
                        iconEl.className = "w-12 h-12 rounded-full flex items-center justify-center text-white bg-purple-500 shadow-md animate-bounce";
                        barEl.className = "h-1 bg-purple-500 w-full";
                        iconEl.innerHTML = `<i data-feather="map-pin"></i>`;
                        triggerNotification("Mise √† jour Livraison üõµ", "Votre commande est pr√™te ou en route.");

                    } else if (data.status === 'ready' || data.status === 'delivered') {
                        statusEl.innerText = data.type === 'livraison' ? "Bon app√©tit ! (Livr√©)" : "Votre commande est Pr√™te !";
                        iconEl.className = "w-12 h-12 rounded-full flex items-center justify-center text-white bg-green-500 shadow-md bounce";
                        barEl.className = "h-1 bg-green-500 w-full";
                        iconEl.innerHTML = `<i data-feather="check"></i>`;
                        triggerNotification("C'est Pr√™t ! üöÄ", "Commande termin√©e.");

                    } else if (data.status === 'rejected') {
                        statusEl.innerText = "Commande Annul√©e";
                        iconEl.className = "w-12 h-12 rounded-full flex items-center justify-center text-white bg-red-500 shadow-md";
                        barEl.className = "h-1 bg-red-500 w-full";
                        iconEl.innerHTML = `<i data-feather="x"></i>`;
                    }
                    feather.replace(); 
                });
            },
            error: (error) => {
                console.error("Tracker Error:", error);
            }
        });
    }
    
    window.closeTracker = () => { if(activeOrderUnsubscribe) activeOrderUnsubscribe(); localStorage.removeItem('activeOrderId'); document.getElementById('orderTracker').classList.remove('tracker-visible'); };

    // --- RENDER DELIVERY ZONES ---
    function renderDeliveryZones() {
        const container = document.getElementById('zoneList');
        if(!container) return;
        container.innerHTML = DELIVERY_ZONES.map(z => `
            <label class="block relative border-2 border-slate-200 dark:border-slate-600 rounded-xl p-4 cursor-pointer hover:border-orange-500 transition-all has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50 dark:has-[:checked]:bg-orange-900/10 group">
                <input type="radio" name="deliveryZone" value="${z.id}" class="hidden" onchange="handleZoneSelection(${z.id})">
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-slate-800 dark:text-white text-lg">${z.name}</span>
                    <span class="font-bold text-orange-600 bg-orange-100 dark:bg-orange-900/30 px-2 py-1 rounded-lg text-sm">${z.price} Dh</span>
                </div>
                <div class="text-xs text-slate-500 dark:text-slate-400 leading-relaxed">${z.areas}</div>
                <div class="absolute top-4 right-4 w-5 h-5 rounded-full border-2 border-slate-300 group-has-[:checked]:border-orange-500 group-has-[:checked]:bg-orange-500 flex items-center justify-center">
                    <svg class="w-3 h-3 text-white hidden group-has-[:checked]:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </div>
            </label>
        `).join('');
    }

    window.handleZoneSelection = (id) => {
        selectedZoneId = id;
        document.getElementById('btnConfirmZone').disabled = false;
    };

    window.confirmDeliveryZone = () => {
        if (!selectedZoneId) return;
        const zone = DELIVERY_ZONES.find(z => z.id === selectedZoneId);
        checkoutData.deliveryPrice = zone.price;
        checkoutData.location = `Livraison: ${zone.name} (${zone.price} Dh)`;
        
        switchModal('deliveryZoneModal', 'summaryModal');
        openSummary('livraison');
    };

    // --- FETCH FUNCTIONS ---
    async function fetchCategories() {
        try {
            const q = query(collection(db, "categories"), orderBy("order"));
            const snap = await getDocs(q);
            const container = document.getElementById('categoryFilters');
            let html = `<button onclick="filterSection('all')" class="filter-btn active px-6 py-3 text-sm font-bold bg-white dark:bg-slate-800 shadow-sm text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700" data-cat="all">Tout</button>`;
            allCategories = [];
            snap.forEach(doc => {
                const d = doc.data();
                allCategories.push(d.name);
                categoryImages[d.name] = d.image;
                if (d.image) {
                    html += `<button onclick="filterSection('${d.name}')" class="filter-btn filter-btn-image w-auto min-w-[120px] h-[46px] px-4 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-sm" style="background-image: url('${d.image}')" data-cat="${d.name}"><span class="relative z-10 drop-shadow-md">${d.name}</span></button>`;
                } else {
                    html += `<button onclick="filterSection('${d.name}')" class="filter-btn px-6 py-3 text-sm font-bold bg-white dark:bg-slate-800 shadow-sm text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700" data-cat="${d.name}">${d.name}</button>`;
                }
            });
            container.innerHTML = html;
        } catch (e) { console.error(e); }
    }

    async function fetchItems() {
        try {
            const q = query(collection(db, "menuItems"), orderBy('order', 'asc'));
            const snap = await getDocs(q);
            
            allItems = [];
            snap.forEach(doc => {
                const data = doc.data();
                if (data.isVisible !== false) {
                    allItems.push({ id: doc.id, ...data });
                }
            });
            
            allItems.sort((a, b) => (a.order || 0) - (b.order || 0));
            
            renderMenuSections(allItems);
            renderPopular(allItems);
        } catch (e) { console.error("Error fetching items:", e); }
    }
    
    async function fetchPromotions() {
        try {
            const snap = await getDocs(collection(db, "promotions"));
            const container = document.getElementById('promotionsGrid');
            const section = document.getElementById('promotions');
            allPromotions = [];
            snap.forEach(doc => {
                 const data = doc.data();
                 if(data.isVisible !== false) {
                     allPromotions.push({ id: doc.id, isPromo: true, ...data });
                 }
            });
            if (container && allPromotions.length > 0) {
                section.classList.remove('hidden');
                container.innerHTML = allPromotions.map(item => `
                    <div class="menu-card snap-center shrink-0 w-[280px] cursor-pointer" onclick="openItemModal('${item.id}', true)">
                        <div class="relative">
                            <img src="${item.imageUrl || categoryImages[item.category] || 'assets/snack.png'}" alt="${item.name}" class="menu-card-image" loading="lazy">
                            <div class="absolute top-3 left-3 bg-red-600 text-white text-xs font-bold px-2.5 py-1 rounded-md shadow-md">-PROMO-</div>
                        </div>
                        <div class="menu-card-content">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white truncate mb-1">${item.name}</h3>
                            <div class="menu-card-price-container pt-3 mt-3"><span class="text-xl font-bold text-red-600">${item.price} Dh</span></div>
                        </div>
                    </div>`).join('');
            }
        } catch(e) { console.error(e); }
    }

    function renderMenuSections(items) {
        const container = document.getElementById('menuContent');
        container.innerHTML = '';
        
        const grouped = {};
        allCategories.forEach(cat => grouped[cat] = []);
        items.forEach(item => { 
            const cat = item.category || 'Autres';
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(item); 
        });

        const knownCats = new Set(allCategories);
        const extraCats = Object.keys(grouped).filter(c => !knownCats.has(c));
        const renderOrder = [...allCategories, ...extraCats];

        let hasContent = false;

        for (const catName of renderOrder) {
            const catItems = grouped[catName];
            if (!catItems || catItems.length === 0) continue;
            hasContent = true;
            
            const section = document.createElement('div');
            section.className = 'mb-16 section-block scroll-mt-28 fade-in-immediate';
            section.id = `section-${catName}`; 
            
            section.innerHTML = `<div class="flex items-center gap-4 mb-8"><h3 class="text-3xl font-bold text-slate-800 dark:text-white relative after:content-[''] after:absolute after:-bottom-2 after:left-0 after:w-12 after:h-1 after:bg-orange-500 after:rounded-full">${catName}</h3><div class="h-px bg-slate-200 dark:bg-slate-700 flex-1 mt-2 ml-4"></div></div><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">${catItems.map(item => createCardHTML(item)).join('')}</div>`;
            container.appendChild(section);
        }
        
        if (!hasContent) {
            container.innerHTML = '<div class="flex flex-col items-center justify-center py-20 text-slate-400"><svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg><p class="text-lg font-medium">Le menu est en cours de pr√©paration...</p></div>';
        }
    }

    function createCardHTML(item) {
        return `<div class="menu-card group cursor-pointer" onclick="openItemModal('${item.id}')"><div class="overflow-hidden relative h-[240px]"><img src="${item.imageUrl}" alt="${item.name}" class="menu-card-image" loading="lazy"></div><div class="menu-card-content"><h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2 leading-tight group-hover:text-orange-600 dark:group-hover:text-orange-400 transition-colors">${item.name}</h3><p class="text-sm text-slate-500 dark:text-slate-400 mb-4 leading-relaxed line-clamp-2">${item.description || ''}</p><div class="menu-card-price-container"><p class="text-2xl font-bold text-orange-600 dark:text-orange-400">${item.price} <span class="text-sm text-slate-400 dark:text-slate-500 font-normal">MAD</span></p><button class="add-btn shadow-sm"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg></button></div></div></div>`;
    }

    function renderPopular(items) {
        const popContainer = document.getElementById('popularGrid');
        const popSection = document.getElementById('popular');
        const populars = items.filter(item => item.isPopular === true);
        
        if (!popContainer || populars.length === 0) { 
            if(popSection) popSection.classList.add('hidden'); 
            return; 
        }
        
        popSection.classList.remove('hidden'); 
        popContainer.innerHTML = populars.map(item => `
            <div class="menu-card snap-center shrink-0 w-[280px] cursor-pointer" onclick="openItemModal('${item.id}')">
                <div class="relative h-[180px]">
                    <img src="${item.imageUrl || categoryImages[item.category] || 'assets/snack.png'}" alt="${item.name}" class="w-full h-full object-cover rounded-t-2xl">
                    <div class="absolute top-3 left-3 bg-orange-500 text-white text-xs font-bold px-2.5 py-1 rounded-md shadow-md">POPULAIRE</div>
                </div>
                <div class="p-4">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white truncate mb-1">${item.name}</h3>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-xl font-bold text-slate-800 dark:text-white">${item.price} Dh</span>
                        <button class="add-btn"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg></button>
                    </div>
                </div>
            </div>`).join('');
    }

    window.filterSection = (catName) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`button[data-cat="${catName}"]`);
        if(btn) btn.classList.add('active');
        document.querySelectorAll('.section-block').forEach(sec => {
            if (catName === 'all' || sec.id === `section-${catName}`) {
                sec.classList.remove('hidden');
                sec.classList.remove('fade-in-immediate');
                void sec.offsetWidth; 
                sec.classList.add('fade-in-immediate');
            }
            else sec.classList.add('hidden');
        });
        if(catName !== 'all') { const el = document.getElementById(`section-${catName}`); if(el) window.scrollTo({top: el.getBoundingClientRect().top + window.pageYOffset - 260, behavior: 'smooth'}); }
    };

    document.getElementById('menuSearch').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.menu-card').forEach(card => {
            card.style.display = card.querySelector('h3').innerText.toLowerCase().includes(term) ? 'flex' : 'none';
        });
    });

    // --- WIZARD LOGIC ---
    window.openItemModal = (id, isPromo = false) => {
        currentItem = isPromo ? allPromotions.find(i => i.id === id) : allItems.find(i => i.id === id);
        if (!currentItem) return;
        
        modalQty = 1;
        wizardData = {}; 
        
        document.getElementById('modalQtyDisplay').innerText = 1;
        document.getElementById('modalItemName').innerText = currentItem.name;
        document.getElementById('modalItemBasePrice').innerText = currentItem.price + " MAD";
        document.getElementById('modalItemDesc').innerText = currentItem.description || '';
        document.getElementById('modalItemImage').src = currentItem.imageUrl || categoryImages[currentItem.category] || 'assets/snack.png';
        
        wizardSteps = [];
        if (currentItem.mandatoryChoices && currentItem.mandatoryChoices.length > 0) {
            currentItem.mandatoryChoices.forEach(group => {
                wizardSteps.push({ type: 'choice', data: group, title: group.title });
            });
        }
        if (currentItem.supplements && currentItem.supplements.length > 0) {
            wizardSteps.push({ type: 'supplements', data: currentItem.supplements, title: "Suppl√©ments" });
        }

        const isWizard = wizardSteps.length > 1;
        const wizardProgress = document.getElementById('wizardProgress');
        const wizardNav = document.getElementById('wizardNav');
        const simpleNav = document.getElementById('simpleNav');
        const modalHeader = document.getElementById('modalHeader');
        
        if (isWizard) {
            currentStepIndex = 0;
            wizardProgress.classList.remove('hidden');
            wizardNav.classList.remove('hidden');
            simpleNav.classList.add('hidden');
            modalHeader.classList.add('h-32', 'sm:h-40'); 
            modalHeader.classList.remove('h-48', 'sm:h-56');
            renderWizardStep(0);
        } else {
            wizardProgress.classList.add('hidden');
            wizardNav.classList.add('hidden');
            simpleNav.classList.remove('hidden');
            modalHeader.classList.remove('h-32', 'sm:h-40');
            modalHeader.classList.add('h-48', 'sm:h-56');
            renderSimpleView();
        }
        
        window.calcModalTotal(); 
        openModalAnimation('addItemModal');
    };

    window.renderWizardStep = (stepIndex) => {
        const container = document.getElementById('wizardContainer');
        const step = wizardSteps[stepIndex];
        const totalSteps = wizardSteps.length;
        
        document.getElementById('wizardProgressBar').style.width = `${((stepIndex + 1) / totalSteps) * 100}%`;
        
        const prevBtn = document.getElementById('btnWizardPrev');
        const nextBtn = document.getElementById('btnWizardNext');
        
        prevBtn.style.visibility = stepIndex === 0 ? 'hidden' : 'visible';
        nextBtn.innerText = stepIndex === totalSteps - 1 ? 'Ajouter au Panier' : 'Suivant';
        
        let html = `<div class="wizard-step-container active animate-scale-in">
            <h4 class="text-xl font-bold text-slate-800 dark:text-white mb-1">${step.title}</h4>
            <p class="text-sm text-slate-400 mb-6 step-subtitle">Faites votre choix</p>`;
            
        const isSelected = (name) => wizardData[stepIndex]?.some(i => i.name === name);

        if (step.type === 'choice') {
            const group = step.data;
            const isSize = group.title.toLowerCase().includes('taille') || group.title.toLowerCase().includes('size');
            
            if (isSize) {
                html += `<div class="grid grid-cols-2 sm:grid-cols-4 gap-3">`;
                group.options.forEach((opt) => {
                    const sel = isSelected(opt.name);
                    const safeName = opt.name.replace(/'/g, "\\'"); 
                    html += `<div class="size-card border-2 ${sel ? 'selected border-orange-500 bg-orange-50' : 'border-slate-100 dark:border-slate-700'} rounded-xl p-4 text-center cursor-pointer hover:border-orange-400 transition" onclick="selectWizardOption(this, 'radio', ${stepIndex}, '${safeName}')">
                        <input type="radio" name="wiz_step_${stepIndex}" value="${opt.name}" data-price="${opt.price}" class="hidden option-input" ${sel ? 'checked' : ''}>
                        <div class="font-bold text-xl mb-1 dark:text-white">${opt.name}</div>
                        ${opt.price > 0 ? `<div class="text-xs font-bold text-slate-400">+${opt.price} Dh</div>` : ''}
                    </div>`;
                });
                html += `</div>`;
            } else {
                html += `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">`;
                const inputType = (group.type === 'checkbox') ? 'checkbox' : 'radio';
                group.options.forEach((opt) => {
                    const sel = isSelected(opt.name);
                    const safeName = opt.name.replace(/'/g, "\\'"); 
                    html += `<div class="option-card border ${sel ? 'selected border-orange-500 bg-orange-50' : 'border-slate-200 dark:border-slate-700'} rounded-xl p-3 flex items-center justify-between cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700" onclick="selectWizardOption(this, '${inputType}', ${stepIndex}, '${safeName}')">
                        <div class="flex items-center gap-3 pointer-events-none">
                            <div class="w-5 h-5 rounded ${inputType==='radio'?'rounded-full':''} border-2 border-slate-300 flex items-center justify-center option-indicator transition">
                                <div class="w-2.5 h-2.5 bg-orange-500 rounded-full transition-all ${sel ? 'opacity-100 scale-100' : 'opacity-0 scale-0'}"></div>
                            </div>
                            <span class="font-bold text-slate-700 dark:text-slate-200">${opt.name}</span>
                        </div>
                        <input type="${inputType}" name="wiz_step_${stepIndex}" value="${opt.name}" data-price="${opt.price}" class="hidden option-input" ${sel ? 'checked' : ''}>
                        ${opt.price > 0 ? `<span class="text-xs font-bold text-slate-400">+${opt.price} Dh</span>` : ''}
                    </div>`;
                });
                html += `</div>`;
                if(group.min > 0) html += `<p class="text-xs text-red-500 mt-2 hidden min-error">Veuillez s√©lectionner ${group.min} option(s).</p>`;
            }
        } else if (step.type === 'supplements') {
            html += `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">`;
            step.data.forEach(sup => {
                const sel = isSelected(sup.name);
                const safeName = sup.name.replace(/'/g, "\\'"); 
                html += `<div class="option-card border ${sel ? 'selected border-orange-500 bg-orange-50' : 'border-slate-200 dark:border-slate-700'} rounded-xl p-3 flex items-center justify-between cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700" onclick="selectWizardOption(this, 'checkbox', ${stepIndex}, '${safeName}')">
                    <div class="flex items-center gap-3 pointer-events-none">
                        <div class="w-5 h-5 rounded border-2 border-slate-300 flex items-center justify-center option-indicator transition">
                             <div class="w-2.5 h-2.5 bg-orange-500 rounded-full transition-all ${sel ? 'opacity-100 scale-100' : 'opacity-0 scale-0'}"></div>
                        </div>
                        <span class="font-bold text-slate-700 dark:text-slate-200">${sup.name}</span>
                    </div>
                    <input type="checkbox" name="wiz_step_${stepIndex}" value="${sup.name}" data-price="${sup.price}" class="hidden option-input" ${sel ? 'checked' : ''}>
                    <span class="text-xs font-bold text-orange-600">+${sup.price} Dh</span>
                </div>`;
            });
            html += `</div>`;
        }
        
        html += `</div>`;
        container.innerHTML = html;
        validateWizardStep();
    };

    window.selectWizardOption = (card, type, stepIndex, val) => {
        if(!wizardData[stepIndex]) wizardData[stepIndex] = [];

        const input = card.querySelector('input');
        const price = parseFloat(input.dataset.price || 0);

        if (type === 'radio') {
            const container = card.parentElement;
            container.querySelectorAll('.option-input').forEach(el => {
                el.checked = false;
                const parent = el.closest('div[onclick]');
                parent.classList.remove('selected', 'border-orange-500', 'bg-orange-50');
                parent.classList.add('border-slate-100'); 
                const ind = parent.querySelector('.option-indicator div');
                if(ind) { ind.classList.remove('opacity-100', 'scale-100'); ind.classList.add('opacity-0', 'scale-0'); }
            });
            
            input.checked = true;
            card.classList.add('selected', 'border-orange-500', 'bg-orange-50');
            card.classList.remove('border-slate-100');
            const indicator = card.querySelector('.option-indicator div');
            if(indicator) { indicator.classList.add('opacity-100', 'scale-100'); indicator.classList.remove('opacity-0', 'scale-0'); }
            
            wizardData[stepIndex] = [{ name: val, price: price }];

        } else {
            const step = wizardSteps[stepIndex];
            let max = 999;
            if (step.type === 'choice' && step.data.max) max = parseInt(step.data.max);

            const currentData = wizardData[stepIndex];
            const alreadySelected = currentData.some(i => i.name === val);

            if (!alreadySelected) {
                if (currentData.length < max) {
                    input.checked = true;
                    card.classList.add('selected', 'border-orange-500', 'bg-orange-50');
                    card.classList.remove('border-slate-200');
                    const ind = card.querySelector('.option-indicator div');
                    if(ind) { ind.classList.add('opacity-100', 'scale-100'); ind.classList.remove('opacity-0', 'scale-0'); }
                    
                    wizardData[stepIndex].push({ name: val, price: price });
                }
            } else {
                input.checked = false;
                card.classList.remove('selected', 'border-orange-500', 'bg-orange-50');
                card.classList.add('border-slate-200');
                const ind = card.querySelector('.option-indicator div');
                if(ind) { ind.classList.remove('opacity-100', 'scale-100'); ind.classList.add('opacity-0', 'scale-0'); }
                
                wizardData[stepIndex] = wizardData[stepIndex].filter(i => i.name !== val);
            }
        }
        
        validateWizardStep();
        recalcWizardTotal();
    };
    
    window.recalcWizardTotal = () => {
        let total = currentItem.price;
        Object.values(wizardData).forEach(stepItems => {
            stepItems.forEach(item => total += item.price);
        });
        total *= modalQty;
        const display = document.getElementById('modalTotalPriceDisplay');
        if(display) display.innerText = (Number.isInteger(total) ? total : total.toFixed(2)) + ' Dh';
    };

    window.validateWizardStep = () => {
        const step = wizardSteps[currentStepIndex];
        const btn = document.getElementById('btnWizardNext');
        const container = document.querySelector('.wizard-step-container');
        
        let isValid = true;
        const currentData = wizardData[currentStepIndex] || [];
        
        if (step.type === 'choice') {
            const min = parseInt(step.data.min) || 0;
            const max = parseInt(step.data.max) || 0;
            const type = step.data.type;
            
            if ((type === 'radio' || type === 'select') && currentData.length === 0) {
                isValid = false;
            }
            if (type === 'checkbox') {
                if (currentData.length < min) isValid = false;
                const sub = container.querySelector('.step-subtitle');
                if (sub) {
                    sub.innerText = `S√©lectionn√©: ${currentData.length} / ${max || '‚àû'} (Min: ${min})`;
                    if (isValid) {
                        sub.classList.remove('text-orange-500');
                        sub.classList.add('text-green-600');
                    } else {
                        sub.classList.remove('text-green-600');
                        sub.classList.add('text-orange-500');
                    }
                }
            }
        }
        
        if (btn) {
            btn.disabled = !isValid;
            if (isValid) {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        return isValid;
    };

    window.handleWizardAction = (action) => {
        const container = document.getElementById('wizardContainer').firstElementChild;
        if (action === 'next') {
            if (currentStepIndex < wizardSteps.length - 1) {
                container.classList.add('animate-slide-out-left');
                setTimeout(() => {
                    currentStepIndex++;
                    renderWizardStep(currentStepIndex);
                }, 200); 
            } else {
                addToCartFromModal();
            }
        } else {
            if (currentStepIndex > 0) {
                container.classList.add('animate-slide-out-right');
                setTimeout(() => {
                    currentStepIndex--;
                    renderWizardStep(currentStepIndex);
                }, 200);
            }
        }
    };

    window.renderSimpleView = () => {
        const container = document.getElementById('wizardContainer');
        let html = `<div class="space-y-6">`;
        
        wizardSteps.forEach((step, index) => {
            if (step.type === 'choice') {
                const group = step.data;
                html += `<div><h4 class="font-bold mb-2 text-slate-800 dark:text-white">${group.title}</h4>`;
                group.options.forEach(opt => {
                    const safeName = opt.name.replace(/"/g, '&quot;');
                    html += `<label class="flex items-center justify-between p-3 border rounded-xl mb-2 cursor-pointer hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-700 transition">
                       <div class="flex items-center gap-3">
                           <input type="${group.type==='checkbox'?'checkbox':'radio'}" name="simple_opt_${index}" value="${safeName}" data-price="${opt.price}" class="option-input w-5 h-5 text-orange-500 focus:ring-orange-500 rounded border-slate-300" onchange="calcModalTotal()">
                           <span class="dark:text-white font-medium">${opt.name}</span>
                       </div>
                       ${opt.price > 0 ? `<span class="text-sm font-bold text-slate-400">+${opt.price} Dh</span>` : ''}
                    </label>`;
                });
                html += `</div>`;
            } else if (step.type === 'supplements') {
                html += `<div><h4 class="font-bold mb-2 text-slate-800 dark:text-white">Suppl√©ments</h4>`;
                step.data.forEach(sup => {
                    const safeName = sup.name.replace(/"/g, '&quot;');
                    html += `<label class="flex items-center justify-between p-3 border rounded-xl mb-2 cursor-pointer hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-700 transition">
                       <div class="flex items-center gap-3">
                           <input type="checkbox" class="supp-check w-5 h-5 text-orange-500 rounded focus:ring-orange-500 border-slate-300" value="${safeName}" data-price="${sup.price}" onchange="calcModalTotal()">
                           <span class="dark:text-white font-medium">${sup.name}</span>
                       </div>
                       <span class="text-sm font-bold text-slate-400">+${sup.price} Dh</span>
                    </label>`;
                });
                html += `</div>`;
            }
        });
        
        html += `</div>`;
        container.innerHTML = html;
        window.calcModalTotal();
    };

    window.calcModalTotal = () => {
        let total = currentItem.price;
        const PRICES = {
            'M':  { 'Gratinage': 5,  'Gratinage 2': 8  }, 
            'L':  { 'Gratinage': 8,  'Gratinage 2': 12 }, 
            'XL': { 'Gratinage': 10, 'Gratinage 2': 15 },
            'XXL':{ 'Gratinage': 15, 'Gratinage 2': 20 }
        };

        if (wizardSteps.length > 1) {
            let selectedSize = null;
            let suppStepIndex = -1;

            wizardSteps.forEach((step, idx) => {
                if (step.type === 'choice' && step.data.title.toLowerCase().includes('taille')) {
                    if (wizardData[idx] && wizardData[idx][0]) {
                        selectedSize = wizardData[idx][0].name;
                    }
                }
                if (step.type === 'supplements') {
                    suppStepIndex = idx;
                }
            });

            if (selectedSize && suppStepIndex > -1 && wizardData[suppStepIndex]) {
                const sizeKey = Object.keys(PRICES).find(k => selectedSize.includes(k)) || 'M';
                const priceList = PRICES[sizeKey];

                wizardData[suppStepIndex].forEach(supp => {
                    Object.keys(priceList).forEach(gratinName => {
                        if (supp.name.toLowerCase().includes(gratinName.toLowerCase())) {
                            supp.price = priceList[gratinName];
                        }
                    });
                });
            }

            Object.values(wizardData).forEach(stepItems => {
                if (Array.isArray(stepItems)) {
                    stepItems.forEach(item => total += item.price);
                }
            });

        } else {
            document.querySelectorAll('.option-input:checked').forEach(i => total += parseFloat(i.dataset.price || 0));
            document.querySelectorAll('.supp-check:checked').forEach(i => total += parseFloat(i.dataset.price || 0));
        }

        total *= modalQty;
        document.getElementById('modalTotalPriceDisplay').innerText = (Number.isInteger(total) ? total : total.toFixed(2)) + ' Dh';
        return total;
    };

    window.addToCartFromModal = () => {
        const opts = []; 
        const supps = [];
        let finalPrice = currentItem.price;

        if (wizardSteps.length > 1) {
            Object.keys(wizardData).forEach(key => {
                const stepIdx = parseInt(key);
                const step = wizardSteps[stepIdx];
                if(step.type === 'choice') {
                    wizardData[key].forEach(i => opts.push({name: i.name}));
                } else {
                    wizardData[key].forEach(i => supps.push({name: i.name, price: i.price}));
                }
            });
            let wizardAddons = 0;
            Object.values(wizardData).forEach(stepItems => stepItems.forEach(item => wizardAddons += item.price));
            finalPrice += wizardAddons;
            finalPrice *= modalQty;
        } else {
            document.querySelectorAll('.option-input:checked').forEach(i => opts.push({name: i.value}));
            document.querySelectorAll('.supp-check:checked').forEach(i => supps.push({name: i.value, price: parseFloat(i.dataset.price)}));
            finalPrice = window.calcModalTotal() || (currentItem.price * modalQty);
        }

        cart.push({
            cartId: Date.now(),
            id: currentItem.id,
            name: currentItem.name,
            imageUrl: currentItem.imageUrl,
            qty: modalQty,
            selectedOptions: opts,
            supplements: supps,
            totalPrice: finalPrice
        });
        localStorage.setItem('bigtacCart', JSON.stringify(cart));
        updateCartUI();
        
        const fab = document.getElementById('fabCart');
        fab.classList.add('animate-bounce');
        setTimeout(() => fab.classList.remove('animate-bounce'), 1000);

        closeAddItemModal();
        
        const t = document.getElementById('toast'); 
        t.innerHTML = `<div class="bg-orange-500 rounded-full p-1"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div><span class="font-bold text-sm">Ajout√© au panier !</span>`;
        t.classList.remove('hidden', 'bg-orange-600');
        t.classList.add('bg-slate-800', 'dark:bg-slate-700');
        setTimeout(() => { t.classList.remove('opacity-0', 'translate-y-10'); }, 10);
        setTimeout(() => { t.classList.add('opacity-0', 'translate-y-10'); setTimeout(()=> t.classList.add('hidden'), 300); }, 3000);
    };

    window.closeAddItemModal = () => { closeModalAnimation('addItemModal'); };
    window.updateModalQty = (d) => { 
        if(modalQty+d>0) { 
            modalQty+=d; 
            document.getElementById('modalQtyDisplay').innerText = modalQty; 
            window.calcModalTotal();
        }
    };
    
    window.finalizeOrder = async () => {
        if (!appConfig.isOpen) {
            alert("‚ö†Ô∏è D√©sol√©, le restaurant est actuellement ferm√©.");
            return;
        }
        
        if (Notification.permission !== "granted") Notification.requestPermission();
        const type = checkoutData.type;
        if(cart.length === 0) return;
        
        const btn = document.getElementById('btnFinalize');
        if(btn) { btn.innerText = "Traitement..."; btn.disabled = true; }

        let total = cart.reduce((acc, i) => acc + i.totalPrice, 0);
        // Add Dynamic Delivery Fee if applicable
        if(type === 'livraison') total += checkoutData.deliveryPrice;
        
        if (appConfig.whatsappMode) {
            const phoneNumber = WHATSAPP_NUMBERS['default'];
            
            let message = `*Nouvelle Commande - BIGTAC*\n\n`;
            message += `üë§ *Nom:* ${checkoutData.name}\n`;
            message += `üìû *T√©l:* ${checkoutData.phone}\n`;
            message += `üì¶ *Mode:* ${type.toUpperCase()}\n`;
            
            if(type === 'livraison') {
                 message += `üìç *Zone:* ${checkoutData.location}\n`;
            } else {
                 message += `üìç *Lieu:* ${checkoutData.location}\n`;
            }
            message += `\n`;
            
            message += `*Articles:*\n`;
            cart.forEach(item => {
                message += `- ${item.qty}x ${item.name}`;
                const opts = [...item.selectedOptions, ...item.supplements].map(o => o.name).join(', ');
                if(opts) message += ` (${opts})`;
                message += `\n`;
            });
            
            message += `\nüí∞ *Total:* ${total.toFixed(2)} Dh`;
            if(checkoutData.note) message += `\nüìù *Note:* ${checkoutData.note}`;
            
            cart = []; localStorage.setItem('bigtacCart', '[]'); updateCartUI(); 
            closeModalAnimation('summaryModal');
            
            window.open(`https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`, '_blank');
            if(btn) { btn.innerText = "Confirmer la Commande"; btn.disabled = false; }
            return;
        }

        try {
            let shortId = 0;
            await runTransaction(db, async (transaction) => {
                const counterRef = doc(db, "settings", "orderCounter");
                const counterDoc = await transaction.get(counterRef);
                
                if (!counterDoc.exists()) {
                    shortId = 1;
                    transaction.set(counterRef, { currentId: 1 });
                } else {
                    let newId = counterDoc.data().currentId + 1;
                    if (newId > 200) newId = 1;
                    shortId = newId;
                    transaction.update(counterRef, { currentId: newId });
                }
            });

            const orderData = {
                shortId: shortId, 
                customer: { name: checkoutData.name, phone: checkoutData.phone, note: checkoutData.note || "" },
                items: cart.map(item => ({
                    name: item.name,
                    qty: item.qty,
                    price: item.totalPrice,
                    imageUrl: item.imageUrl || "",
                    options: [...item.selectedOptions, ...item.supplements].map(o => o.name)
                })),
                total: total,
                type: type,
                location: checkoutData.location,
                status: 'pending',
                createdAt: serverTimestamp()
            };

            const docRef = await addDoc(collection(db, 'orders'), orderData);
            localStorage.setItem('activeOrderId', docRef.id);
            initOrderTracker();
            cart = []; localStorage.setItem('bigtacCart', '[]'); updateCartUI(); 
            closeModalAnimation('summaryModal');

            const toast = document.getElementById('toast');
            toast.innerHTML = `<div class="bg-green-500 rounded-full p-1"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div><span class="font-bold text-sm">Commande #${shortId} envoy√©e !</span>`;
            toast.classList.remove('hidden', 'bg-slate-800'); toast.classList.add('bg-green-600');
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); setTimeout(()=> toast.classList.add('hidden'), 300); }, 4000);
        } catch (error) { 
            console.error("Error sending order: ", error); 
            alert("Erreur lors de l'envoi. Veuillez r√©essayer."); 
        } finally { 
            if(btn) { btn.innerText = "Confirmer la Commande"; btn.disabled = false; } 
        }
    };
    
    // --- CART & UI FUNCTIONS ---
    window.updateCartUI = () => {
        const container = document.getElementById('cartItemsContainer');
        const totalEl = document.getElementById('cartFinalTotal');
        const navCount = document.getElementById('navCartCount');
        const fabCount = document.getElementById('fabCount');
        
        let totalQty = 0;
        let totalPrice = 0;
        
        container.innerHTML = '';
        
        if (cart.length === 0) {
            container.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-slate-400"><svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg><p>Votre panier est vide</p></div>';
            navCount.classList.add('hidden', 'scale-0');
            fabCount.parentElement.parentElement.classList.add('scale-0'); 
        } else {
            cart.forEach((item, index) => {
                totalQty += item.qty;
                totalPrice += item.totalPrice;
                
                const optionsStr = [...(item.selectedOptions||[]).map(o=>o.name), ...(item.supplements||[]).map(s=>s.name)].join(', ');
                
                container.innerHTML += `
                    <div class="flex gap-4 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-100 dark:border-slate-700 animate-scale-in">
                        <img src="${item.imageUrl || 'assets/snack.png'}" class="w-16 h-16 rounded-lg object-cover bg-white">
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-slate-800 dark:text-white truncate pr-2">${item.name}</h4>
                                <span class="font-bold text-orange-600 whitespace-nowrap">${item.totalPrice.toFixed(2)} Dh</span>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-2 truncate">${optionsStr}</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600 px-2 py-1">
                                    <button onclick="updateCartItemQty(${index}, -1)" class="text-slate-400 hover:text-orange-600 font-bold">-</button>
                                    <span class="text-xs font-bold w-4 text-center dark:text-white">${item.qty}</span>
                                    <button onclick="updateCartItemQty(${index}, 1)" class="text-slate-400 hover:text-orange-600 font-bold">+</button>
                                </div>
                                
                                <button onclick="removeCartItem(${index})" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 flex items-center justify-center rounded-full transition shadow-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            navCount.innerText = totalQty;
            navCount.classList.remove('hidden', 'scale-0');
            fabCount.innerText = totalQty;
            fabCount.parentElement.parentElement.classList.remove('scale-0');
        }
        
        totalEl.innerText = totalPrice.toFixed(2) + ' Dh';
    };

    window.updateCartItemQty = (index, change) => {
        const item = cart[index];
        const unitPrice = item.totalPrice / item.qty;
        if (item.qty + change > 0) {
            item.qty += change;
            item.totalPrice = unitPrice * item.qty;
        } else {
            return; 
        }
        localStorage.setItem('bigtacCart', JSON.stringify(cart));
        updateCartUI();
    };

    window.removeCartItem = (index) => {
        cart.splice(index, 1);
        localStorage.setItem('bigtacCart', JSON.stringify(cart));
        updateCartUI();
    };

    window.openCart = () => {
        const modal = document.getElementById('cartModal');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.lastElementChild.classList.remove('translate-x-full');
        }, 10);
    };

    window.closeCart = () => {
        const modal = document.getElementById('cartModal');
        modal.lastElementChild.classList.add('translate-x-full');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    };

    // --- CHECKOUT FLOW ---
    window.openCheckoutModal = () => {
        if(cart.length === 0) return;
        closeCart();
        openModalAnimation('nameModal');
    };

    window.nextCheckoutStep = () => {
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        const note = document.getElementById('customerNote').value.trim();
        const phoneError = document.getElementById('phoneError');
        
        if (name.length < 2) { alert("Nom invalide"); return; }
        if (!/^(06|07|05)\d{8}$/.test(phone.replace(/\s/g, ''))) {
            phoneError.classList.remove('hidden');
            return;
        }
        phoneError.classList.add('hidden');
        
        checkoutData.name = name;
        checkoutData.phone = phone;
        checkoutData.note = note;
        
        // Skip Location Modal, Go to Service Type
        switchModal('nameModal', 'serviceModal');
    };

    // New Service Selection Logic
    window.selectService = (type) => {
        checkoutData.type = type;
        
        if (type === 'livraison') {
            // Open Zones Modal
            document.getElementById('btnConfirmZone').disabled = true;
            document.querySelectorAll('input[name="deliveryZone"]').forEach(el => el.checked = false);
            selectedZoneId = null;
            switchModal('serviceModal', 'deliveryZoneModal');
        } else {
            // Pick up / Eat in -> Fixed Address
            checkoutData.deliveryPrice = 0;
            checkoutData.location = type === 'sur_place' ? 'Sur Place (Rue Abdelkrim Benjelloun)' : 'A Emporter (Rue Abdelkrim Benjelloun)';
            openSummary(type);
            switchModal('serviceModal', 'summaryModal');
        }
    };

    window.openSummary = (type) => {
        document.getElementById('summaryName').innerText = checkoutData.name;
        document.getElementById('summaryPhone').innerText = checkoutData.phone;
        document.getElementById('summaryLocation').innerText = checkoutData.location; // Shows Zone info if delivery
        document.getElementById('summaryType').innerText = type === 'sur_place' ? 'Sur Place' : (type === 'emporter' ? 'A Emporter' : 'Livraison');
        
        const itemsContainer = document.getElementById('summaryItems');
        itemsContainer.innerHTML = cart.map(i => `<div class="flex justify-between"><span>${i.qty}x ${i.name}</span><span>${i.totalPrice} Dh</span></div>`).join('');
        
        let total = cart.reduce((acc, i) => acc + i.totalPrice, 0);
        const delFeeEl = document.getElementById('summaryDeliveryFee');
        
        if (type === 'livraison') {
            delFeeEl.classList.remove('hidden');
            document.getElementById('deliveryPriceDisplay').innerText = checkoutData.deliveryPrice.toFixed(2) + ' Dh';
            total += checkoutData.deliveryPrice;
        } else {
            delFeeEl.classList.add('hidden');
        }
        
        document.getElementById('summaryTotal').innerText = total.toFixed(2) + ' Dh';
    };
    
    window.contactWhatsApp = () => window.open('https://wa.me/212663339105', '_blank');
    window.contactCall = () => window.open('tel:+212663339105', '_self');

    function triggerNotification(title, body) {
        try { 
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 
            audio.play().catch(e => {}); 
        } catch(e) {}

        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

        if (Notification.permission === "granted") {
            new Notification(title, { body: body, icon: 'assets/logo.png' });
        }
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>