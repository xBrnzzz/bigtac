<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIGTAC - Studio Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: { 
                        brand: { 50: '#fff7ed', 100: '#ffedd5', 500: '#ea580c', 600: '#c2410c', 900: '#7c2d12' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #f8fafc; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background: #ffedd5; border: 2px dashed #ea580c; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .mobile-tab-active { background-color: #ea580c; color: white; border-color: #ea580c; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #ea580c; }
        .toggle-checkbox:checked + .toggle-label { background-color: #ea580c; }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen overflow-hidden flex flex-col md:flex-row">

    <!-- LOGIN OVERLAY -->
    <div id="login-section" class="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-sm p-8 rounded-3xl shadow-2xl animate-fade-in">
            <div class="text-center mb-8">
                
                <img src="assets/logo.png" alt="Logo" class="h-24 w-auto mx-auto mb-4 object-contain">
                
                <h1 class="text-2xl font-bold text-slate-800">Admin Panel</h1>
            </div>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none font-medium" placeholder="Email" required>
                <input type="password" id="password" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none font-medium" placeholder="Mot de passe" required>
                <button type="submit" class="w-full py-4 bg-brand-500 hover:bg-brand-600 text-white rounded-xl font-bold shadow-lg transition transform active:scale-95">Connexion</button>
                <p id="login-error" class="text-red-500 text-sm text-center hidden bg-red-50 py-2 rounded-lg">Erreur de connexion</p>
            </form>
        </div>
    </div>

    <!-- MOBILE HEADER -->
    <header class="md:hidden bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 flex-none z-30">
        <div class="flex items-center gap-2">
            <img src="assets/logo.png" alt="Logo" class="h-8 w-8 object-contain">
            
            <span class="font-bold text-lg">Admin</span>
        </div>
        <button onclick="toggleMobileMenu()" class="p-2 text-slate-600 bg-slate-50 rounded-lg"><i data-feather="menu"></i></button>
    </header>

    <!-- MOBILE MENU -->
    <div id="mobile-menu" class="md:hidden hidden absolute top-16 left-0 w-full bg-white shadow-xl border-b border-slate-200 z-40 p-2 space-y-1">
        <!-- Mobile Daily Revenue -->
        <div class="bg-slate-50 rounded-xl p-3 border border-slate-100 mx-1 mb-2">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Chiffre du jour</div>
            <div id="mobile-daily-revenue" class="text-2xl font-extrabold text-slate-800">0.00 <span class="text-sm font-medium text-slate-400">Dh</span></div>
        </div>

        <!-- Mobile Settings -->
        <div class="border-t border-slate-100 my-2 pt-2 space-y-3 px-2">
            <div class="flex items-center justify-between">
                <span class="text-sm font-bold text-slate-700">Restaurant Ouvert</span>
                <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" id="mobile-toggle-store" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300"/>
                    <label for="mobile-toggle-store" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex flex-col">
                    <span class="text-sm font-bold text-slate-700">Mode WhatsApp</span>
                    <span class="text-[10px] text-slate-400">Commandes directes</span>
                </div>
                <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" id="mobile-toggle-whatsapp" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300"/>
                    <label for="mobile-toggle-whatsapp" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                </div>
            </div>
        </div>
        <button onclick="switchView('orders'); toggleMobileMenu()" class="w-full text-left p-3 font-bold rounded-lg hover:bg-slate-50 flex items-center gap-3"><i data-feather="shopping-bag" class="w-4 h-4"></i> Commandes</button>
        <button onclick="switchView('menu'); toggleMobileMenu()" class="w-full text-left p-3 font-bold rounded-lg hover:bg-slate-50 flex items-center gap-3"><i data-feather="grid" class="w-4 h-4"></i> Menu</button>
        <button onclick="switchView('categories'); toggleMobileMenu()" class="w-full text-left p-3 font-bold rounded-lg hover:bg-slate-50 flex items-center gap-3"><i data-feather="list" class="w-4 h-4"></i> Catégories</button>
        <button onclick="switchView('promotions'); toggleMobileMenu()" class="w-full text-left p-3 font-bold rounded-lg hover:bg-slate-50 flex items-center gap-3"><i data-feather="gift" class="w-4 h-4"></i> Promotions</button>
        <div class="border-t border-slate-100 my-1"></div>
        <button onclick="signOut(auth); toggleMobileMenu()" class="w-full text-left p-3 font-bold text-red-500 rounded-lg hover:bg-red-50 flex items-center gap-3"><i data-feather="log-out" class="w-4 h-4"></i> Déconnexion</button>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-72 bg-white border-r border-slate-200 flex-col hidden md:flex z-20">
        <div class="p-6 flex items-center gap-3">
             <img src="assets/logo.png" alt="Logo" class="h-10 w-10 object-contain">
             
            <div><h1 class="font-bold text-lg leading-none">BIGTAC</h1><span class="text-[10px] font-bold text-brand-500 uppercase tracking-wider">Studio</span></div>
        </div>
        
        <div class="px-6 mb-2">
            <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Chiffre du jour</div>
                <div id="daily-revenue" class="text-2xl font-extrabold text-slate-800">0.00 <span class="text-sm font-medium text-slate-400">Dh</span></div>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-2 mt-2">
            <button onclick="switchView('orders')" id="nav-orders" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-brand-600 bg-brand-50 transition"><i data-feather="shopping-bag" class="w-5 h-5"></i> Commandes <span id="badge-pending" class="ml-auto bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full hidden">0</span></button>
            
            <button onclick="switchView('menu')" id="nav-menu" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-slate-500 hover:bg-slate-50 transition"><i data-feather="grid" class="w-5 h-5"></i> Menu & Carte</button>
            <button onclick="switchView('categories')" id="nav-categories" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-slate-500 hover:bg-slate-50 transition"><i data-feather="list" class="w-5 h-5"></i> Catégories</button>
            <button onclick="switchView('promotions')" id="nav-promotions" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-slate-500 hover:bg-slate-50 transition"><i data-feather="gift" class="w-5 h-5"></i> Promotions</button>
        </nav>
        
        <!-- SETTINGS PANEL -->
        <div class="px-4 py-4 space-y-3 bg-slate-50 border-t border-slate-100">
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider px-2">Paramètres</div>
            
            <div class="flex items-center justify-between px-2">
                <span class="text-sm font-bold text-slate-700">Restaurant Ouvert</span>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="toggle-store" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300"/>
                    <label for="toggle-store" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                </div>
            </div>

            <div class="flex items-center justify-between px-2">
                <div class="flex flex-col">
                    <span class="text-sm font-bold text-slate-700">Mode WhatsApp</span>
                    <span class="text-[10px] text-slate-400">Commandes via WhatsApp</span>
                </div>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="toggle-whatsapp" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300"/>
                    <label for="toggle-whatsapp" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-slate-100">
            <button id="logout-btn" class="w-full flex items-center justify-center gap-2 text-sm font-bold text-red-500 hover:bg-red-50 py-3 rounded-xl transition"><i data-feather="log-out" class="w-4 h-4"></i> Déconnexion</button>
        </div>
    </aside>

    <!-- MAIN VIEWS -->
    <div id="views-container" class="flex-1 overflow-hidden relative bg-slate-50/50">

        <!-- VIEW: ORDERS -->
        <div id="view-orders" class="absolute inset-0 p-4 sm:p-6 flex flex-col gap-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-800">Commandes</h2>
                <div class="text-xs font-bold bg-green-100 text-green-700 px-3 py-1 rounded-full flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Live</div>
            </div>
            <div class="flex sm:hidden gap-2 pb-2 overflow-x-auto">
                <button onclick="showOrderCol('pending')" id="mtab-pending" class="mobile-tab-active flex-1 py-2 px-4 rounded-lg text-sm font-bold border shadow-sm transition whitespace-nowrap">En Attente <span id="m-badge-pending" class="bg-white text-brand-600 text-[10px] px-1.5 rounded-full ml-1">0</span></button>
                <button onclick="showOrderCol('confirmed')" id="mtab-confirmed" class="bg-white text-slate-500 flex-1 py-2 px-4 rounded-lg text-sm font-bold border border-slate-200 shadow-sm transition whitespace-nowrap">Cuisine</button>
                <button onclick="showOrderCol('delivery')" id="mtab-delivery" class="bg-white text-slate-500 flex-1 py-2 px-4 rounded-lg text-sm font-bold border border-slate-200 shadow-sm transition whitespace-nowrap">Livraison</button>
                <button onclick="showOrderCol('history')" id="mtab-history" class="bg-white text-slate-500 flex-1 py-2 px-4 rounded-lg text-sm font-bold border border-slate-200 shadow-sm transition whitespace-nowrap">Terminé</button>
            </div>
            <div class="flex-1 grid grid-cols-1 lg:grid-cols-4 gap-6 min-h-0 overflow-hidden">
                <div id="col-pending" class="flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 h-full overflow-hidden">
                    <div class="p-3 border-b border-slate-100 bg-amber-50/50 flex justify-between items-center"><h3 class="font-bold text-amber-700 flex items-center gap-2"><i data-feather="clock" class="w-4 h-4"></i> En Attente</h3><span id="count-pending" class="bg-white px-2 py-0.5 rounded-md text-xs font-bold shadow-sm">0</span></div>
                    <div id="list-pending" class="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-50/30"></div>
                </div>
                <div id="col-confirmed" class="hidden lg:flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 h-full overflow-hidden">
                    <div class="p-3 border-b border-slate-100 bg-blue-50/50 flex justify-between items-center"><h3 class="font-bold text-blue-700 flex items-center gap-2"><i data-feather="loader" class="w-4 h-4"></i> En Cuisine</h3><span id="count-confirmed" class="bg-white px-2 py-0.5 rounded-md text-xs font-bold shadow-sm">0</span></div>
                    <div id="list-confirmed" class="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-50/30"></div>
                </div>
                <div id="col-delivery" class="hidden lg:flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 h-full overflow-hidden">
                    <div class="p-3 border-b border-slate-100 bg-purple-50/50 flex justify-between items-center">
                        <h3 class="font-bold text-purple-700 flex items-center gap-2">
                            <i data-feather="truck" class="w-4 h-4"></i> En Livraison
                        </h3>
                        <span id="count-delivery" class="bg-white px-2 py-0.5 rounded-md text-xs font-bold shadow-sm">0</span>
                    </div>
                    <div id="list-delivery" class="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-50/30"></div>
                </div>
                <div id="col-history" class="hidden lg:flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 h-full overflow-hidden">
                    <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><h3 class="font-bold text-slate-600 flex items-center gap-2"><i data-feather="check-circle" class="w-4 h-4"></i> Terminé</h3><span id="count-history" class="bg-white px-2 py-0.5 rounded-md text-xs font-bold shadow-sm">0</span></div>
                    <div id="list-history" class="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-50/30"></div>
                </div>
            </div>
        </div>
        
        <!-- Rest of the code remains same as previous version but with branding colors applied via Tailwind Config -->
        <!-- Just ensuring the content is fully replaced to avoid partial updates -->

        <!-- VIEW: MENU -->
        <div id="view-menu" class="absolute inset-0 p-4 sm:p-6 hidden bg-slate-50 flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none">
                <h2 class="text-2xl font-bold text-slate-900">Menu</h2>
                <div class="flex gap-2">
                    <button onclick="saveItemOrder()" id="btn-save-order" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-900 shadow transition flex items-center gap-2"><i data-feather="save" class="w-3 h-3"></i> Sauvegarder l'ordre</button>
                    <button onclick="openItemEditor()" class="bg-brand-500 hover:bg-brand-600 text-white px-3 py-2 rounded-lg font-bold text-xs shadow-sm transition flex items-center gap-1"><i data-feather="plus" class="w-4 h-4"></i> <span class="hidden sm:inline">Ajouter</span></button>
                </div>
            </div>
            <div class="flex-1 flex flex-col sm:flex-row gap-4 min-h-0">
                <div class="w-full sm:w-64 flex-none flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden max-h-32 sm:max-h-full">
                    <div class="hidden sm:block p-3 border-b border-slate-100 font-bold text-xs text-slate-400 uppercase">Catégories</div>
                    <div id="menu-categories-list" class="flex-1 overflow-x-auto sm:overflow-y-auto p-2 flex sm:flex-col gap-2"></div>
                </div>
                <div class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                     <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                         <span id="active-category-title" class="font-bold text-slate-700">Tous les plats</span>
                         <span class="text-xs text-slate-400 italic">Glissez pour réorganiser</span>
                     </div>
                    <div id="items-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-4 content-start"></div>
                </div>
            </div>
        </div>

        <!-- VIEW: CATEGORIES -->
        <div id="view-categories" class="absolute inset-0 p-6 hidden overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Catégories</h2>
                    <div class="flex gap-2">
                        <button onclick="saveCategoryOrder()" class="text-xs bg-green-100 text-green-700 px-3 py-2 rounded-lg font-bold hover:bg-green-200 transition flex items-center gap-2">
                            <i data-feather="save" class="w-3 h-3"></i> Sauvegarder Ordre
                        </button>
                        <button onclick="openCategoryEditor()" class="bg-brand-500 hover:bg-brand-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2 transition transform active:scale-95">
                            <i data-feather="plus" class="w-4 h-4"></i> Nouvelle Catégorie
                        </button>
                    </div>
                </div>
        
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div id="categories-list-manage" class="space-y-2"></div>
                    <p class="text-center text-xs text-slate-400 mt-4">Glissez les éléments pour réorganiser</p>
                </div>
            </div>
        </div>
        
        <!-- VIEW: PROMOTIONS -->
        <div id="view-promotions" class="absolute inset-0 p-6 hidden overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Promotions</h2>
                    <button onclick="openPromoEditor()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2"><i data-feather="plus"></i> Nouvelle Promo</button>
                </div>
                <div id="promotions-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            </div>
        </div>
    </div>
    
    <!-- Modals are loaded via JS, reusing existing structure -->
    <!-- Keeping existing modal structures for item/promo editor -->
    
    <!-- ITEM EDITOR MODAL -->
    <div id="item-editor" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeItemEditor()"></div>
        <div class="absolute inset-y-0 right-0 w-full max-w-2xl bg-white shadow-2xl transform transition-transform translate-x-full flex flex-col h-full">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                <h3 class="text-xl font-bold text-slate-800" id="editor-title">Nouveau Plat</h3>
                <button onclick="closeItemEditor()" class="p-2 hover:bg-slate-100 rounded-full"><i data-feather="x"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto bg-slate-50 p-6">
                <form id="item-form" class="space-y-6">
                    <input type="hidden" id="edit-item-id">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Nom</label><input type="text" id="input-name" class="w-full p-3 bg-slate-50 border rounded-xl font-bold mt-1" required></div>
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Prix (DH)</label><input type="number" id="input-price" step="0.5" class="w-full p-3 bg-slate-50 border rounded-xl font-mono font-bold mt-1" required></div>
                        </div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Description</label><textarea id="input-desc" rows="2" class="w-full p-3 bg-slate-50 border rounded-xl text-sm mt-1"></textarea></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Catégorie</label><select id="input-category" class="w-full p-3 bg-slate-50 border rounded-xl font-bold outline-none mt-1"></select></div>
                            <div class="flex flex-col justify-center gap-2 pt-4">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="input-popular" class="w-4 h-4 text-brand-500 rounded"><span class="text-sm font-bold">Populaire</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="input-visible" class="w-4 h-4 text-brand-500 rounded" checked><span class="text-sm font-bold">Visible</span></label>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Image (Cloudinary)</label>
                            <div class="flex gap-4 items-center mt-1">
                                <div id="image-preview" class="w-16 h-16 bg-slate-100 rounded-lg flex items-center justify-center overflow-hidden border"><i data-feather="image" class="text-slate-300"></i></div>
                                <input type="file" id="input-image-file" accept="image/*" class="text-sm text-slate-500 w-full">
                                <input type="hidden" id="input-image-url"> 
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="flex border-b border-slate-100">
                            <button type="button" onclick="switchEditorTab('choices')" id="tab-choices" class="flex-1 py-3 text-sm font-bold text-brand-600 border-b-2 border-brand-500 bg-brand-50/50 transition">Variantes</button>
                            <button type="button" onclick="switchEditorTab('supplements')" id="tab-supplements" class="flex-1 py-3 text-sm font-bold text-slate-500 hover:bg-slate-50 transition">Suppléments</button>
                        </div>
                        <div class="p-5">
                            <div id="panel-choices" class="space-y-4">
                                <div class="flex justify-between items-center"><span class="text-xs text-slate-400">Étapes (ex: Taille, Viande)</span><button type="button" onclick="addChoiceGroup()" class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-lg font-bold">+ Groupe</button></div>
                                <div id="container-choices" class="space-y-3"></div>
                            </div>
                            <div id="panel-supplements" class="hidden space-y-4">
                                <div class="flex justify-between items-center"><span class="text-xs text-slate-400">Options payantes</span><button type="button" onclick="addSupplementRow()" class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-lg font-bold">+ Option</button></div>
                                <div id="container-supplements" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="p-5 border-t border-slate-100 bg-white z-10"><button onclick="saveItem()" id="btn-save-item" class="w-full py-3 bg-brand-500 hover:bg-brand-600 text-white rounded-xl font-bold shadow-lg transition">Enregistrer</button></div>
        </div>
    </div>

    <!-- PROMO EDITOR MODAL -->
    <div id="promo-editor" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closePromoEditor()"></div>
        <div class="absolute inset-y-0 right-0 w-full max-w-2xl bg-white shadow-2xl transform transition-transform translate-x-full flex flex-col h-full">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                <h3 class="text-xl font-bold text-slate-800" id="promo-editor-title">Nouvelle Promo</h3>
                <button onclick="closePromoEditor()" class="p-2 hover:bg-slate-100 rounded-full"><i data-feather="x"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto bg-slate-50 p-6">
                <form id="promo-form" class="space-y-6">
                    <input type="hidden" id="edit-promo-id">
                    
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Nom</label><input type="text" id="promo-name" class="w-full p-3 bg-slate-50 border rounded-xl font-bold" required></div>
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Prix (DH)</label><input type="number" id="promo-price" step="0.5" class="w-full p-3 bg-slate-50 border rounded-xl font-mono font-bold text-red-500" required></div>
                        </div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Description</label><textarea id="promo-desc" rows="2" class="w-full p-3 bg-slate-50 border rounded-xl text-sm"></textarea></div>
                        <div class="flex items-center gap-2 pt-2"><input type="checkbox" id="promo-visible" class="w-5 h-5 text-brand-500 rounded" checked><span class="text-sm font-bold text-slate-700">Active</span></div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Image</label>
                            <div class="flex gap-4 items-center mt-1">
                                <div id="promo-image-preview" class="w-16 h-16 bg-slate-100 rounded-lg flex items-center justify-center overflow-hidden border"><i data-feather="image" class="text-slate-300"></i></div>
                                <input type="file" id="promo-image-file" accept="image/*" class="text-sm text-slate-500 w-full">
                                <input type="hidden" id="promo-image-url">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="flex border-b border-slate-100">
                            <button type="button" onclick="switchPromoTab('choices')" id="promo-tab-choices" class="flex-1 py-3 text-sm font-bold text-brand-600 border-b-2 border-brand-500 bg-brand-50/50 transition">Variantes</button>
                            <button type="button" onclick="switchPromoTab('supplements')" id="promo-tab-supplements" class="flex-1 py-3 text-sm font-bold text-slate-500 hover:bg-slate-50 transition">Suppléments</button>
                        </div>
                        <div class="p-5">
                            <div id="promo-panel-choices" class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-400">Étapes (ex: Choix Boisson)</span>
                                    <button type="button" onclick="addPromoChoiceGroup()" class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-lg font-bold">+ Groupe</button>
                                </div>
                                <div id="promo-container-choices" class="space-y-3"></div>
                            </div>
                            <div id="promo-panel-supplements" class="hidden space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-400">Options payantes</span>
                                    <button type="button" onclick="addPromoSupplementRow()" class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-lg font-bold">+ Option</button>
                                </div>
                                <div id="promo-container-supplements" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="p-5 border-t border-slate-100 bg-white z-10">
                <button onclick="savePromo()" id="btn-save-promo" class="w-full py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold shadow-lg transition">Sauvegarder Promo</button>
            </div>
        </div>
    </div>
    <div id="category-editor-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeCategoryEditor()"></div>
        <div class="absolute inset-y-0 right-0 w-full max-w-md bg-white shadow-2xl transform transition-transform translate-x-full flex flex-col h-full">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                <h3 class="text-xl font-bold text-slate-800" id="cat-editor-title">Nouvelle Catégorie</h3>
                <button onclick="closeCategoryEditor()" class="p-2 hover:bg-slate-100 rounded-full transition"><i data-feather="x"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto bg-slate-50 p-6">
                <form id="category-form" class="space-y-6">
                    <input type="hidden" id="cat-id">
                    
    
                    <input type="hidden" id="cat-original-name"> 
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Nom de la catégorie</label>
                            <input type="text" id="cat-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none transition" required placeholder="Ex: Burgers">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Image (Optionnelle)</label>
                            <div class="flex items-center gap-3 mt-1">
                                <div id="cat-image-preview" class="w-16 h-16 bg-slate-100 rounded-xl flex items-center justify-center border border-slate-200 overflow-hidden shrink-0">
                                    <i data-feather="image" class="w-6 h-6 text-slate-300"></i>
                                </div>
                                <div class="flex-1">
                                    <input type="file" id="cat-image-file" accept="image/*" class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100">
                                    <p class="text-[10px] text-slate-400 mt-1">Format carré recommandé.</p>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <div class="pt-2">
                        <button type="submit" id="btn-save-cat" class="w-full py-3 bg-brand-500 hover:bg-brand-600 text-white rounded-xl font-bold shadow-lg transition transform active:scale-95">Enregistrer</button>
                        <button type="button" onclick="closeCategoryEditor()" class="w-full mt-3 py-3 text-slate-400 text-sm font-bold hover:text-slate-600 transition">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- JS Logic Reused from original file, ensures everything works as before -->
    <script type="module">
        import { auth, db, signInWithEmailAndPassword, onAuthStateChanged, signOut, collection, addDoc, getDocs, deleteDoc, updateDoc, getDoc, doc, query, orderBy, onSnapshot, serverTimestamp, writeBatch, where, setDoc } from './firebase-config.js';
        window.auth = auth;
        window.signOut = signOut;
        const CLOUDINARY_CLOUD_NAME = "dv0vnjnto"; 
        const CLOUDINARY_PRESET = "qaoutiassets"; 

        feather.replace();

        onAuthStateChanged(auth, user => {
            if(user) { document.getElementById('login-section').classList.add('hidden'); initApp(); } 
            else { document.getElementById('login-section').classList.remove('hidden'); }
        });
        
        document.getElementById('login-form').addEventListener('submit', async e => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); }
            catch(e) { document.getElementById('login-error').classList.remove('hidden'); }
        });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        window.toggleMobileMenu = () => document.getElementById('mobile-menu').classList.toggle('hidden');

        let categories = [], items = [], currentCategoryFilter = 'all';
        let sortableItems = null, sortableCategories = null;

        async function initApp() {
            await loadCategories(); await loadItems(); await loadPromotions(); initOrders(); initSettings();
            switchView('orders');
            
            const setupPreview = (fileId, imgId) => {
                document.getElementById(fileId).addEventListener('change', function(e) {
                    if(this.files[0]) document.getElementById(imgId).innerHTML = `<img src="${URL.createObjectURL(this.files[0])}" class="w-full h-full object-cover">`;
                });
            };
            setupPreview('input-image-file', 'image-preview');
            setupPreview('promo-image-file', 'promo-image-preview');
            setupPreview('cat-image-file', 'cat-image-preview');
        }

        // --- SETTINGS LOGIC ---
        function initSettings() {
            const configRef = doc(db, 'settings', 'config');
            onSnapshot(configRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    document.getElementById('toggle-store').checked = data.isOpen !== false;
                    document.getElementById('toggle-whatsapp').checked = data.whatsappMode === true;
                    
                    const mobileStore = document.getElementById('mobile-toggle-store');
                    const mobileWa = document.getElementById('mobile-toggle-whatsapp');
                    if(mobileStore) mobileStore.checked = data.isOpen !== false;
                    if(mobileWa) mobileWa.checked = data.whatsappMode === true;
                } else {
                    setDoc(configRef, { isOpen: true, whatsappMode: false });
                }
            });

            const handleStoreToggle = async (isChecked) => {
                await updateDoc(configRef, { isOpen: isChecked });
                if (!isChecked) {
                    const batch = writeBatch(db);
                    const q = query(collection(db, "orders"), where("status", "==", "pending"));
                    const snap = await getDocs(q);
                    snap.forEach(doc => {
                        batch.update(doc.ref, { status: 'rejected' });
                    });
                    if (!snap.empty) {
                        await batch.commit();
                        alert(`${snap.size} commandes en attente ont été annulées.`);
                    }
                }
            };

            document.getElementById('toggle-store').addEventListener('change', (e) => handleStoreToggle(e.target.checked));
            const mobileStoreBtn = document.getElementById('mobile-toggle-store');
            if(mobileStoreBtn) mobileStoreBtn.addEventListener('change', (e) => handleStoreToggle(e.target.checked));

            const handleWaToggle = async (isChecked) => {
                await updateDoc(configRef, { whatsappMode: isChecked });
            };

            document.getElementById('toggle-whatsapp').addEventListener('change', (e) => handleWaToggle(e.target.checked));
            const mobileWaBtn = document.getElementById('mobile-toggle-whatsapp');
            if(mobileWaBtn) mobileWaBtn.addEventListener('change', (e) => handleWaToggle(e.target.checked));
            
            calculateDailyRevenue();
            setInterval(calculateDailyRevenue, 60000);
        }

        async function calculateDailyRevenue() {
            const today = new Date();
            today.setHours(0,0,0,0);
            const q = query(collection(db, "orders"), where("createdAt", ">=", today));
            const snap = await getDocs(q);
            let total = 0;
            snap.forEach(doc => {
                const data = doc.data();
                if (data.status !== 'rejected') {
                    total += parseFloat(data.total || 0);
                }
            });
            document.getElementById('daily-revenue').innerHTML = `${total.toFixed(2)} <span class="text-sm font-medium text-slate-400">Dh</span>`;
            const mobileRev = document.getElementById('mobile-daily-revenue');
            if(mobileRev) mobileRev.innerHTML = `${total.toFixed(2)} <span class="text-sm font-medium text-slate-400">Dh</span>`;
        }

        window.switchView = (viewId) => {
            ['orders', 'menu', 'categories', 'promotions'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                const nav = document.getElementById(`nav-${v}`);
                if(nav) { nav.classList.replace('text-brand-600', 'text-slate-500'); nav.classList.remove('bg-brand-50'); }
            });
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            const active = document.getElementById(`nav-${viewId}`);
            if(active) { active.classList.replace('text-slate-500', 'text-brand-600'); active.classList.add('bg-brand-50'); }
        };

        window.showOrderCol = (col) => {
            ['pending', 'confirmed', 'delivery', 'history'].forEach(c => {
                document.getElementById(`col-${c}`).classList.remove('flex'); document.getElementById(`col-${c}`).classList.add('hidden');
                const btn = document.getElementById(`mtab-${c}`);
                btn.className = (c === col) ? "mobile-tab-active flex-1 py-2 px-4 rounded-lg text-sm font-bold border shadow-sm transition whitespace-nowrap" : "bg-white text-slate-500 flex-1 py-2 px-4 rounded-lg text-sm font-bold border border-slate-200 shadow-sm transition whitespace-nowrap";
            });
            document.getElementById(`col-${col}`).classList.remove('hidden'); document.getElementById(`col-${col}`).classList.add('flex');
        };

        function initOrders() {
            const q = query(collection(db, 'orders'), orderBy('createdAt', 'desc'));
            onSnapshot(q, snap => {
                const pending=[], confirmed=[], delivery=[], history=[];
                snap.forEach(doc => {
                    const o = {id: doc.id, ...doc.data()};
                    if(o.status === 'pending') pending.push(o);
                    else if(o.status === 'confirmed') confirmed.push(o);
                    else if(o.status === 'en_livraison') delivery.push(o);
                    else history.push(o);
                });

                document.getElementById('badge-pending').innerText = pending.length; 
                document.getElementById('badge-pending').classList.toggle('hidden', pending.length === 0);
                document.getElementById('m-badge-pending').innerText = pending.length;
                document.getElementById('count-pending').innerText = pending.length; 
                document.getElementById('count-confirmed').innerText = confirmed.length; 
                document.getElementById('count-delivery').innerText = delivery.length;
                document.getElementById('count-history').innerText = history.length;

                renderOrderList('list-pending', pending, 'pending'); 
                renderOrderList('list-confirmed', confirmed, 'confirmed'); 
                renderOrderList('list-delivery', delivery, 'delivery');
                renderOrderList('list-history', history, 'history');
                
                calculateDailyRevenue();
            });
        }

        function renderOrderList(containerId, orders, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            orders.forEach(o => {
                const date = o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--';
                let actions = '';
                if(type === 'pending') {
                    actions = `<div class="flex gap-2 mt-4 pt-3 border-t border-slate-100"><button onclick="setStatus('${o.id}', 'confirmed')" class="flex-1 bg-green-500 text-white py-2 rounded-xl text-xs font-bold hover:bg-green-600 shadow-sm transition">ENVOYER EN CUISINE</button><button onclick="setStatus('${o.id}', 'rejected')" class="w-10 bg-red-50 text-red-500 rounded-xl hover:bg-red-100 flex items-center justify-center"><i data-feather="x" class="w-4 h-4"></i></button></div>`;
                } 
                else if(type === 'confirmed') {
                    actions = `<button onclick="setStatus('${o.id}', 'en_livraison')" class="w-full mt-4 pt-2 bg-purple-500 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-purple-600 shadow-sm transition flex items-center justify-center gap-2"><i data-feather="truck" class="w-4 h-4"></i> PRÊT / LIVRAISON</button>`;
                } 
                else if(type === 'delivery') {
                    actions = `<button onclick="setStatus('${o.id}', 'ready')" class="w-full mt-4 pt-2 bg-slate-800 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-slate-900 shadow-sm transition flex items-center justify-center gap-2"><i data-feather="check" class="w-4 h-4"></i> MARQUER LIVRÉ</button>`;
                }
                let rawPhone = o.customer.phone || '';
                let cleanPhone = rawPhone.replace(/\D/g, ''); 
                if (cleanPhone.startsWith('0')) cleanPhone = '212' + cleanPhone.substring(1); 
                const waLink = `https://wa.me/${cleanPhone}`;
                const itemsHtml = o.items.map(i => {
                    const opts = i.options ? i.options.map(opt => `<div class="text-xs text-slate-400 pl-3 border-l-2 border-slate-100 ml-1 my-0.5">• ${opt}</div>`).join('') : '';
                    return `<div class="mb-2"><div class="flex justify-between text-sm font-bold text-slate-700"><span><span class="text-slate-400 mr-1">${i.qty}x</span> ${i.name}</span></div>${opts}</div>`;
                }).join('');

                container.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition fade-in mb-3 order-card group">
                        <div class="flex justify-between items-start mb-3 border-b border-slate-50 pb-2">
                            <div>
                                <div class="font-bold text-slate-800 text-base flex flex-wrap items-center gap-2">${o.customer.name} <span class="text-xs font-mono text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">#${o.shortId||'--'}</span><span class="text-xs font-mono text-slate-400 flex items-center gap-1 ml-1"><i data-feather="clock" class="w-3 h-3"></i> ${date}</span></div>
                                <div class="flex items-center gap-2 mt-1 text-xs font-bold text-brand-600"><i data-feather="map-pin" class="w-3 h-3"></i> ${o.location || 'Non spécifié'}</div>
                            </div>
                            <div class="flex gap-1">
                                <a href="tel:${cleanPhone}" class="bg-slate-100 hover:bg-green-100 text-slate-600 hover:text-green-600 p-2 rounded-lg transition" title="Appeler"><i data-feather="phone" class="w-4 h-4"></i></a>
                                <a href="${waLink}" target="_blank" class="bg-slate-100 hover:bg-green-100 text-slate-600 hover:text-green-600 p-2 rounded-lg transition" title="WhatsApp"><i data-feather="message-circle" class="w-4 h-4"></i></a>
                            </div>
                        </div>
                        ${o.customer.note ? `<div class="bg-yellow-50 border border-yellow-100 p-3 rounded-xl text-xs text-yellow-800 mb-3 italic flex gap-2"><i data-feather="edit-3" class="w-3 h-3 mt-0.5 flex-none"></i> ${o.customer.note}</div>` : ''}
                        <div class="mb-4">${itemsHtml}</div>
                        <div class="flex justify-between items-center pt-3 border-t border-slate-100"><span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 bg-slate-50 px-2 py-1 rounded-md">${o.type.replace('_', ' ')}</span><span class="font-extrabold text-slate-800 text-lg">${parseFloat(o.total).toFixed(2)} <span class="text-xs font-medium text-slate-400">Dh</span></span></div>
                        ${actions}
                    </div>`;
            });
            feather.replace();
        }

        window.setStatus = async (id, s) => await updateDoc(doc(db, 'orders', id), { status: s });
        // Menu & Category Logic remains identical to previous version (omitted for brevity as it was already provided in prompt context, just updating branding colors via Tailwind config)
        
        async function loadCategories() {
            const snap = await getDocs(query(collection(db, 'categories'), orderBy('order')));
            categories = [];
            const menuList = document.getElementById('menu-categories-list'), manageList = document.getElementById('categories-list-manage'), select = document.getElementById('input-category');
            menuList.innerHTML = `<button onclick="filterItems('all')" id="cat-all" class="w-auto sm:w-full text-left px-4 py-2 sm:py-3 rounded-xl text-sm font-bold transition bg-brand-50 text-brand-700 shrink-0 border border-brand-200 whitespace-nowrap">Tout Voir</button>`;
            manageList.innerHTML = ''; select.innerHTML = '<option value="">Choisir...</option>';
            snap.forEach(d => {
                const c = {id: d.id, ...d.data()}; categories.push(c);
                menuList.innerHTML += `<button onclick="filterItems('${c.name}')" id="cat-${c.id}" class="w-auto sm:w-full text-left px-4 py-2 sm:py-3 rounded-xl text-sm font-medium text-slate-500 hover:bg-slate-100 transition flex items-center gap-3 shrink-0 border border-transparent whitespace-nowrap">${c.image ? `<img src="${c.image}" class="w-6 h-6 rounded-full object-cover">` : ''} ${c.name}</button>`;
                manageList.innerHTML += `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100 group hover:border-brand-200 transition" data-id="${c.id}"><div class="flex items-center gap-3"><span class="drag-handle text-slate-300 cursor-grab hover:text-brand-500"><i data-feather="menu" class="w-4 h-4"></i></span>${c.image ? `<img src="${c.image}" class="w-10 h-10 rounded-lg object-cover bg-white shadow-sm">` : ''}<span class="font-bold text-sm text-slate-700">${c.name}</span></div><div class="flex gap-1 opacity-0 group-hover:opacity-100 transition"><button onclick="editCategory('${c.id}')" class="p-2 bg-white rounded-lg text-blue-500 hover:text-blue-600 shadow-sm"><i data-feather="edit-2" class="w-4 h-4"></i></button><button onclick="deleteCategory('${c.id}')" class="p-2 bg-white rounded-lg text-red-400 hover:text-red-600 shadow-sm"><i data-feather="trash-2" class="w-4 h-4"></i></button></div></div>`;
                select.innerHTML += `<option value="${c.name}">${c.name}</option>`;
            });
            if(sortableCategories) sortableCategories.destroy();
            sortableCategories = new Sortable(manageList, { handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost' });
            feather.replace();
        }

        async function loadItems() {
            const snap = await getDocs(query(collection(db, 'menuItems'), orderBy('order', 'asc')));
            items = []; snap.forEach(d => items.push({id: d.id, ...d.data()}));
            items.sort((a, b) => (a.order||0) - (b.order||0)); renderItems();
        }
        function renderItems() {
            const grid = document.getElementById('items-grid'); 
            grid.innerHTML = '';
            
            const filtered = currentCategoryFilter === 'all' ? items : items.filter(i => i.category === currentCategoryFilter);
            document.getElementById('active-category-title').innerText = currentCategoryFilter === 'all' ? 'Tous les plats' : currentCategoryFilter;
            
            if(filtered.length === 0) { 
                grid.innerHTML = `<div class="col-span-full text-center py-20 text-slate-400 italic">Aucun plat ici.</div>`; 
                return; 
            }
            
            filtered.forEach(item => {
                // Check visibility and popularity
                const isVisible = item.isVisible !== false;
                const isPopular = item.isPopular === true;

                grid.innerHTML += `
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition group relative flex gap-4 items-center" data-id="${item.id}">
                    <div class="drag-handle cursor-grab text-slate-200 hover:text-brand-500 p-2"><i data-feather="move" class="w-4 h-4"></i></div>
                    
                    <div class="relative w-16 h-16 shrink-0">
                        <img src="${item.imageUrl || 'assets/snack.png'}" class="w-full h-full rounded-xl object-cover bg-slate-50 shadow-inner">
                        
                        <div class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-white z-10 ${isVisible ? 'bg-green-500' : 'bg-red-500'}" 
                             title="${isVisible ? 'Visible' : 'Caché'}">
                        </div>

                        ${isPopular ? `
                        <div class="absolute -top-1 -left-1 bg-yellow-400 text-white p-0.5 rounded-full shadow-sm z-10 border-2 border-white">
                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                        </div>` : ''}
                    </div>

                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-slate-800 truncate text-sm mb-1">${item.name}</h4>
                            <button onclick="openItemEditor('${item.id}')" class="text-slate-300 hover:text-brand-500 transition"><i data-feather="edit-3" class="w-4 h-4"></i></button>
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase bg-slate-50 px-1.5 py-0.5 rounded">${item.category}</span>
                                <div class="mt-1 text-brand-600 font-bold text-sm">${item.price} Dh</div>
                            </div>
                            <button onclick="deleteItem('${item.id}')" class="text-red-300 hover:text-red-500 transition"><i data-feather="trash" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>`;
            });
            
            if(sortableItems) sortableItems.destroy();
            sortableItems = new Sortable(grid, { handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost' });
            feather.replace();
        }

        window.filterItems = (cat) => {
            currentCategoryFilter = cat;
            document.querySelectorAll('#menu-categories-list button').forEach(b => { b.classList.remove('bg-brand-50', 'text-brand-700', 'border-brand-200'); b.classList.add('text-slate-500', 'border-transparent'); });
            const active = document.getElementById(cat === 'all' ? 'cat-all' : `cat-${categories.find(c=>c.name===cat)?.id}`);
            if(active) { active.classList.add('bg-brand-50', 'text-brand-700', 'border-brand-200'); active.classList.remove('text-slate-500', 'border-transparent'); }
            renderItems();
        };

        // Item/Promo/Category editors logic reused exactly as is
        window.openItemEditor = (id = null) => {
            document.getElementById('item-editor').classList.remove('hidden'); setTimeout(() => document.getElementById('item-editor').children[1].classList.remove('translate-x-full'), 10);
            document.getElementById('editor-title').innerText = id ? "Modifier le Plat" : "Nouveau Plat"; document.getElementById('edit-item-id').value = id || ''; document.getElementById('item-form').reset(); document.getElementById('container-choices').innerHTML = ''; document.getElementById('container-supplements').innerHTML = ''; document.getElementById('image-preview').innerHTML = '<i data-feather="image" class="text-slate-300"></i>';
            window.switchEditorTab('choices');
            if(id) {
                const item = items.find(i => i.id === id);
                if(item) {
                    document.getElementById('input-name').value = item.name; document.getElementById('input-price').value = item.price; document.getElementById('input-desc').value = item.description||''; document.getElementById('input-category').value = item.category; document.getElementById('input-image-url').value = item.imageUrl||'';
                    if(item.imageUrl) document.getElementById('image-preview').innerHTML = `<img src="${item.imageUrl}" class="w-full h-full object-cover">`;
                    document.getElementById('input-popular').checked = item.isPopular; document.getElementById('input-visible').checked = item.isVisible!==false;
                    if(item.mandatoryChoices) item.mandatoryChoices.forEach(g => addChoiceGroup(g));
                    if(item.supplements) item.supplements.forEach(s => addSupplementRow(s));
                }
            }
            feather.replace();
        };
        window.closeItemEditor = () => { document.getElementById('item-editor').children[1].classList.add('translate-x-full'); setTimeout(() => document.getElementById('item-editor').classList.add('hidden'), 300); };
        window.switchEditorTab = (tab) => {
            document.getElementById('panel-choices').classList.add('hidden'); document.getElementById('panel-supplements').classList.add('hidden');
            document.getElementById('tab-choices').className = "flex-1 py-4 text-sm font-bold text-slate-500 hover:bg-slate-50 transition border-b-2 border-transparent";
            document.getElementById('tab-supplements').className = "flex-1 py-4 text-sm font-bold text-slate-500 hover:bg-slate-50 transition border-b-2 border-transparent";
            document.getElementById(`panel-${tab}`).classList.remove('hidden'); document.getElementById(`tab-${tab}`).className = "flex-1 py-4 text-sm font-bold text-brand-600 border-b-2 border-brand-500 bg-brand-50/50 transition";
        };
        window.addChoiceGroup = (data = null) => {
            const div = document.createElement('div'); div.className = "bg-slate-50 p-4 rounded-xl border border-slate-200 relative group-row animate-fade-in";
            div.innerHTML = `<button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-400 hover:text-red-600 p-1"><i data-feather="x" class="w-4 h-4"></i></button><div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3"><div class="sm:col-span-1"><label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Titre</label><input type="text" class="g-title w-full p-2 border border-slate-200 rounded-lg text-sm font-bold" value="${data?.title||''}" placeholder="Ex: Taille"></div><div class="sm:col-span-1"><label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Type</label><select class="g-type w-full p-2 border border-slate-200 rounded-lg text-sm bg-white"><option value="radio" ${data?.type==='radio'?'selected':''}>Unique (Radio)</option><option value="checkbox" ${data?.type==='checkbox'?'selected':''}>Multiple (Check)</option><option value="select" ${data?.type==='select'?'selected':''}>Liste Déroulante</option></select></div><div class="sm:col-span-1 grid grid-cols-2 gap-2"><div><label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Min</label><input type="number" class="g-min w-full p-2 border border-slate-200 rounded-lg text-sm text-center" value="${data?.min||0}" min="0"></div><div><label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Max</label><input type="number" class="g-max w-full p-2 border border-slate-200 rounded-lg text-sm text-center" value="${data?.max||0}" min="0"></div></div></div><div class="g-options space-y-2 pl-3 border-l-2 border-slate-200"></div><button type="button" onclick="addOptionRow(this)" class="mt-3 text-xs font-bold text-brand-600 hover:underline flex items-center gap-1">+ Choix</button>`;
            document.getElementById('container-choices').appendChild(div);
            const addBtn = div.querySelector('button[onclick^="addOptionRow"]');
            if(data?.options && data.options.length > 0) data.options.forEach(opt => addOptionRow(addBtn, opt)); else addOptionRow(addBtn);
            feather.replace();
        };
        window.addOptionRow = (btn, optData = null) => {
            const row = document.createElement('div'); row.className = "flex gap-2 items-center option-row";
            row.innerHTML = `<input type="text" class="opt-name flex-1 p-2 text-sm border border-slate-200 rounded-lg" placeholder="Nom (ex: Medium)" value="${optData?.name||''}"><input type="number" class="opt-price w-24 p-2 text-sm border border-slate-200 rounded-lg" placeholder="Prix (+)" value="${optData?.price||''}"><button type="button" onclick="this.parentElement.remove()" class="text-slate-400 hover:text-red-500"><i data-feather="minus-circle" class="w-4 h-4"></i></button>`;
            btn.previousElementSibling.appendChild(row); feather.replace();
        };
        window.addSupplementRow = (data = null) => {
            const div = document.createElement('div'); div.className = "flex gap-3 items-center bg-slate-50 p-2 rounded-lg border border-slate-200 supp-row animate-fade-in";
            div.innerHTML = `<input type="text" class="supp-name flex-1 p-2 text-sm border border-slate-200 rounded-lg" placeholder="Nom supplément" value="${data?.name||''}"><input type="number" class="supp-price w-24 p-2 text-sm border border-slate-200 rounded-lg" placeholder="Prix" value="${data?.price||''}"><button type="button" onclick="this.parentElement.remove()" class="text-slate-400 hover:text-red-500 p-1"><i data-feather="trash-2" class="w-4 h-4"></i></button>`;
            document.getElementById('container-supplements').appendChild(div); feather.replace();
        };
        async function uploadToCloudinary(file) {
            const formData = new FormData(); formData.append("file", file); formData.append("upload_preset", CLOUDINARY_PRESET);
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: "POST", body: formData });
            if(!res.ok) throw new Error("Upload failed");
            return (await res.json()).secure_url;
        }
        window.saveItem = async () => {
            const btn = document.getElementById('btn-save-item'); 
            
            // 1. VALIDATION: Check Category
            const categoryVal = document.getElementById('input-category').value;
            if (!categoryVal || categoryVal === "") {
                alert(" Veuillez sélectionner une catégorie pour ce plat.");
                // Highlight the select box red
                document.getElementById('input-category').classList.add('border-red-500', 'bg-red-50');
                setTimeout(() => document.getElementById('input-category').classList.remove('border-red-500', 'bg-red-50'), 2000);
                return; // STOP execution
            }

            btn.innerText = "Enregistrement..."; 
            btn.disabled = true;
            
            try {
                const id = document.getElementById('edit-item-id').value; 
                const fileInput = document.getElementById('input-image-file');
                let imageUrl = document.getElementById('input-image-url').value; 
                
                if (fileInput.files.length > 0) imageUrl = await uploadToCloudinary(fileInput.files[0]);
                
                const data = { 
                    name: document.getElementById('input-name').value, 
                    price: parseFloat(document.getElementById('input-price').value) || 0, 
                    description: document.getElementById('input-desc').value, 
                    category: categoryVal, // Used validated value
                    imageUrl: imageUrl, 
                    isPopular: document.getElementById('input-popular').checked, 
                    isVisible: document.getElementById('input-visible').checked, 
                    mandatoryChoices: [], 
                    supplements: [] 
                };
                
                // Collect Choices
                document.querySelectorAll('.group-row').forEach(g => { 
                    const title = g.querySelector('.g-title').value; 
                    const type = g.querySelector('.g-type').value; 
                    const min = parseInt(g.querySelector('.g-min').value) || 0; 
                    const max = parseInt(g.querySelector('.g-max').value) || 0; 
                    const options = []; 
                    g.querySelectorAll('.option-row').forEach(r => { 
                        const name = r.querySelector('.opt-name').value; 
                        const price = parseFloat(r.querySelector('.opt-price').value) || 0; 
                        if(name) options.push({name, price}); 
                    }); 
                    if(title && options.length > 0) data.mandatoryChoices.push({title, type, options, min, max}); 
                });
                
                // Collect Supplements
                document.querySelectorAll('.supp-row').forEach(r => { 
                    const name = r.querySelector('.supp-name').value; 
                    const price = parseFloat(r.querySelector('.supp-price').value) || 0; 
                    if(name) data.supplements.push({name, price}); 
                });
                
                if(id) await updateDoc(doc(db, 'menuItems', id), data); 
                else { 
                    data.order = items.length; 
                    data.createdAt = serverTimestamp(); 
                    await addDoc(collection(db, 'menuItems'), data); 
                }
                
                closeItemEditor(); 
                loadItems();
                
            } catch(e) { 
                console.error(e); 
                alert('Erreur sauvegarde: ' + e.message); 
            } finally { 
                btn.innerText = "Enregistrer"; 
                btn.disabled = false; 
            }
        };
        window.saveItemOrder = async () => { const list = document.getElementById('items-grid'); const ids = Array.from(list.children).map(c => c.getAttribute('data-id')).filter(Boolean); if(!ids.length) return; const btn = document.getElementById('btn-save-order'); const prevText = btn.innerHTML; btn.innerText = "..."; try { await Promise.all(ids.map((id, index) => updateDoc(doc(db, 'menuItems', id), { order: index }))); alert("Ordre du menu sauvegardé !"); } catch(e) { console.error(e); alert("Erreur."); } finally { btn.innerHTML = prevText; } };
        window.saveCategoryOrder = async () => { const list = document.getElementById('categories-list-manage'); const ids = Array.from(list.children).map(c => c.getAttribute('data-id')).filter(Boolean); try { await Promise.all(ids.map((id, index) => updateDoc(doc(db, 'categories', id), { order: index }))); alert("Ordre des catégories mis à jour !"); loadCategories(); } catch(e) { console.error(e); alert("Erreur."); } };
        window.deleteItem = async (id) => { if(confirm("Supprimer définitivement ?")) { await deleteDoc(doc(db, 'menuItems', id)); loadItems(); } };
        // --- FINAL FIX FOR CATEGORY RENAMING ---
    const catFormRef = document.getElementById('category-form');
    catFormRef.replaceWith(catFormRef.cloneNode(true)); // Clear old listeners

    document.getElementById('category-form').addEventListener('submit', async e => {
        e.preventDefault();
        const btn = document.getElementById('btn-save-cat');
        btn.disabled = true;
        btn.innerText = "Sauvegarde...";
        
        try {
            const id = document.getElementById('cat-id').value;
            const newName = document.getElementById('cat-name').value.trim();
            const oldName = document.getElementById('cat-original-name').value; // Get the safe old name
            const fileInput = document.getElementById('cat-image-file');
            
            let imageUrl = null;
            if (fileInput.files.length > 0) {
                imageUrl = await uploadToCloudinary(fileInput.files[0]);
            }
            
            const data = { name: newName };
            if (imageUrl) data.image = imageUrl;
            
            if (id) {
                // 1. Update the Category
                await updateDoc(doc(db, 'categories', id), data);

                // 2. CHECK: Did the name change?
                if (oldName && oldName !== newName) {
                    console.log(`Renaming items from "${oldName}" to "${newName}"...`);
                    
                    // Find items with the OLD name
                    const q = query(collection(db, 'menuItems'), where('category', '==', oldName));
                    const itemsSnap = await getDocs(q);
                    
                    if (!itemsSnap.empty) {
                        const batch = writeBatch(db);
                        itemsSnap.forEach(doc => {
                            batch.update(doc.ref, { category: newName });
                        });
                        await batch.commit();
                        console.log(`✅ Fixed ${itemsSnap.size} items.`);
                        alert(`Catégorie renommée ! ${itemsSnap.size} articles ont été mis à jour.`);
                    }
                }
            } else {
                data.order = categories.length;
                await addDoc(collection(db, 'categories'), data);
            }
            
            closeCategoryEditor();
            await loadCategories(); 
            await loadItems(); 
            
        } catch(e) {
            console.error(e);
            alert('Erreur: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "Enregistrer";
        }
    });
        window.editCategory = (id) => { const c = categories.find(x => x.id === id); if(c) { document.getElementById('cat-id').value = c.id; document.getElementById('cat-name').value = c.name; document.getElementById('btn-save-cat').innerText = "Modifier"; window.scrollTo({top:0, behavior:'smooth'}); } };
        window.resetCategoryForm = () => { document.getElementById('category-form').reset(); document.getElementById('cat-id').value = ''; document.getElementById('btn-save-cat').innerText = "Enregistrer"; };
        window.deleteCategory = async (id) => { if(confirm("Supprimer ?")) { await deleteDoc(doc(db, 'categories', id)); loadCategories(); } };
        async function loadPromotions() { const snap = await getDocs(collection(db, 'promotions')); const list = document.getElementById('promotions-list'); list.innerHTML = ''; if(snap.empty) { list.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400">Aucune promotion active.</div>`; return; } snap.forEach(d => { const p = {id: d.id, ...d.data()}; list.innerHTML += `<div class="bg-white p-4 rounded-xl border border-red-100 shadow-sm relative group flex gap-4 items-center"><img src="${p.imageUrl || 'assets/snack.png'}" class="w-16 h-16 rounded-lg object-cover bg-red-50"><div class="flex-1"><h4 class="font-bold text-slate-800">${p.name}</h4><div class="text-red-500 font-bold">${p.price} Dh</div><div class="text-xs text-slate-400 mt-1">${p.isVisible ? '🟢 Active' : '🔴 Inactive'}</div></div><div class="flex gap-2"><button onclick="openPromoEditor('${p.id}')" class="p-2 bg-slate-50 text-blue-500 rounded-lg hover:bg-blue-50 transition"><i data-feather="edit-2" class="w-4 h-4"></i></button><button onclick="deletePromo('${p.id}')" class="p-2 bg-slate-50 text-red-500 rounded-lg hover:bg-red-50 transition"><i data-feather="trash-2" class="w-4 h-4"></i></button></div></div>`; }); feather.replace(); }
        window.openPromoEditor = (id = null) => { document.getElementById('promo-editor').classList.remove('hidden'); setTimeout(() => document.getElementById('promo-editor').children[1].classList.remove('translate-x-full'), 10); document.getElementById('promo-editor-title').innerText = id ? "Modifier Promo" : "Nouvelle Promo"; document.getElementById('edit-promo-id').value = id || ''; document.getElementById('promo-form').reset(); document.getElementById('promo-image-preview').innerHTML = '<i data-feather="image" class="text-slate-300"></i>'; if(id) { getDoc(doc(db, "promotions", id)).then(snap => { if (snap.exists()) { const d = snap.data(); document.getElementById('promo-name').value = d.name; document.getElementById('promo-price').value = d.price; document.getElementById('promo-desc').value = d.description || ''; document.getElementById('promo-visible').checked = d.isVisible !== false; document.getElementById('promo-image-url').value = d.imageUrl || ''; if(d.imageUrl) document.getElementById('promo-image-preview').innerHTML = `<img src="${d.imageUrl}" class="w-full h-full object-cover">`; } }); } };
        window.closePromoEditor = () => { document.getElementById('promo-editor').children[1].classList.add('translate-x-full'); setTimeout(() => document.getElementById('promo-editor').classList.add('hidden'), 300); };
        window.savePromo = async () => { const btn = document.getElementById('btn-save-promo'); btn.innerText = "Sauvegarde..."; btn.disabled = true; try { const id = document.getElementById('edit-promo-id').value; const fileInput = document.getElementById('promo-image-file'); let imageUrl = document.getElementById('promo-image-url').value; if (fileInput.files.length > 0) imageUrl = await uploadToCloudinary(fileInput.files[0]); const data = { name: document.getElementById('promo-name').value, price: parseFloat(document.getElementById('promo-price').value)||0, description: document.getElementById('promo-desc').value, imageUrl: imageUrl, isVisible: document.getElementById('promo-visible').checked }; if (id) await updateDoc(doc(db, 'promotions', id), data); else await addDoc(collection(db, 'promotions'), data); closePromoEditor(); loadPromotions(); } catch(e) { console.error(e); alert("Erreur."); } finally { btn.innerText = "Sauvegarder Promo"; btn.disabled = false; } };
        window.deletePromo = async (id) => { if(confirm("Supprimer ?")) { await deleteDoc(doc(db, 'promotions', id)); loadPromotions(); } };
        // --- PROMOTION EDITOR LOGIC FIXES ---

        // 1. Tab Switching for Promo Editor
        window.switchPromoTab = (tab) => {
            document.getElementById('promo-panel-choices').classList.add('hidden');
            document.getElementById('promo-panel-supplements').classList.add('hidden');
            
            document.getElementById('promo-tab-choices').className = "flex-1 py-4 text-sm font-bold text-slate-500 hover:bg-slate-50 transition border-b-2 border-transparent";
            document.getElementById('promo-tab-supplements').className = "flex-1 py-4 text-sm font-bold text-slate-500 hover:bg-slate-50 transition border-b-2 border-transparent";
            
            document.getElementById(`promo-panel-${tab}`).classList.remove('hidden');
            document.getElementById(`promo-tab-${tab}`).className = "flex-1 py-4 text-sm font-bold text-brand-600 border-b-2 border-brand-500 bg-brand-50/50 transition";
        };

        // 2. Add Choice Group (Variants) for Promo
        window.addPromoChoiceGroup = (data = null) => {
            const div = document.createElement('div');
            div.className = "bg-slate-50 p-4 rounded-xl border border-slate-200 relative group-row animate-fade-in";
            div.innerHTML = `
                <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-400 hover:text-red-600 p-1"><i data-feather="x" class="w-4 h-4"></i></button>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
                    <div class="sm:col-span-1">
                        <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Titre</label>
                        <input type="text" class="g-title w-full p-2 border border-slate-200 rounded-lg text-sm font-bold" value="${data?.title||''}" placeholder="Ex: Choix Boisson">
                    </div>
                    <div class="sm:col-span-1">
                        <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Type</label>
                        <select class="g-type w-full p-2 border border-slate-200 rounded-lg text-sm bg-white">
                            <option value="radio" ${data?.type==='radio'?'selected':''}>Unique (Radio)</option>
                            <option value="checkbox" ${data?.type==='checkbox'?'selected':''}>Multiple (Check)</option>
                            <option value="select" ${data?.type==='select'?'selected':''}>Liste Déroulante</option>
                        </select>
                    </div>
                    <div class="sm:col-span-1 grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Min</label><input type="number" class="g-min w-full p-2 border border-slate-200 rounded-lg text-sm text-center" value="${data?.min||0}" min="0"></div>
                        <div><label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Max</label><input type="number" class="g-max w-full p-2 border border-slate-200 rounded-lg text-sm text-center" value="${data?.max||0}" min="0"></div>
                    </div>
                </div>
                <div class="g-options space-y-2 pl-3 border-l-2 border-slate-200"></div>
                <button type="button" onclick="addPromoOptionRow(this)" class="mt-3 text-xs font-bold text-brand-600 hover:underline flex items-center gap-1">+ Choix</button>
            `;
            document.getElementById('promo-container-choices').appendChild(div);
            
            const addBtn = div.querySelector('button[onclick^="addPromoOptionRow"]');
            if(data?.options && data.options.length > 0) {
                data.options.forEach(opt => addPromoOptionRow(addBtn, opt));
            } else {
                addPromoOptionRow(addBtn);
            }
            feather.replace();
        };

        // 3. Add Option Row for Promo
        window.addPromoOptionRow = (btn, optData = null) => {
            const row = document.createElement('div');
            row.className = "flex gap-2 items-center option-row";
            row.innerHTML = `
                <input type="text" class="opt-name flex-1 p-2 text-sm border border-slate-200 rounded-lg" placeholder="Nom (ex: Coca)" value="${optData?.name||''}">
                <input type="number" class="opt-price w-24 p-2 text-sm border border-slate-200 rounded-lg" placeholder="Prix (+)" value="${optData?.price||''}">
                <button type="button" onclick="this.parentElement.remove()" class="text-slate-400 hover:text-red-500"><i data-feather="minus-circle" class="w-4 h-4"></i></button>
            `;
            btn.previousElementSibling.appendChild(row);
            feather.replace();
        };

        // 4. Add Supplement Row for Promo
        window.addPromoSupplementRow = (data = null) => {
            const div = document.createElement('div');
            div.className = "flex gap-3 items-center bg-slate-50 p-2 rounded-lg border border-slate-200 supp-row animate-fade-in";
            div.innerHTML = `
                <input type="text" class="supp-name flex-1 p-2 text-sm border border-slate-200 rounded-lg" placeholder="Nom supplément" value="${data?.name||''}">
                <input type="number" class="supp-price w-24 p-2 text-sm border border-slate-200 rounded-lg" placeholder="Prix" value="${data?.price||''}">
                <button type="button" onclick="this.parentElement.remove()" class="text-slate-400 hover:text-red-500 p-1"><i data-feather="trash-2" class="w-4 h-4"></i></button>
            `;
            document.getElementById('promo-container-supplements').appendChild(div);
            feather.replace();
        };

        // 5. OVERWRITE: Open Promo Editor (to load data)
        window.openPromoEditor = (id = null) => {
            document.getElementById('promo-editor').classList.remove('hidden');
            setTimeout(() => document.getElementById('promo-editor').children[1].classList.remove('translate-x-full'), 10);
            
            document.getElementById('promo-editor-title').innerText = id ? "Modifier Promo" : "Nouvelle Promo";
            document.getElementById('edit-promo-id').value = id || '';
            document.getElementById('promo-form').reset();
            document.getElementById('promo-image-preview').innerHTML = '<i data-feather="image" class="text-slate-300"></i>';
            
            // Clear containers
            document.getElementById('promo-container-choices').innerHTML = '';
            document.getElementById('promo-container-supplements').innerHTML = '';
            
            window.switchPromoTab('choices');

            if(id) {
                getDoc(doc(db, "promotions", id)).then(snap => {
                    if (snap.exists()) {
                        const d = snap.data();
                        document.getElementById('promo-name').value = d.name;
                        document.getElementById('promo-price').value = d.price;
                        document.getElementById('promo-desc').value = d.description || '';
                        document.getElementById('promo-visible').checked = d.isVisible !== false;
                        document.getElementById('promo-image-url').value = d.imageUrl || '';
                        if(d.imageUrl) document.getElementById('promo-image-preview').innerHTML = `<img src="${d.imageUrl}" class="w-full h-full object-cover">`;
                        
                        // Load Variants
                        if(d.mandatoryChoices) d.mandatoryChoices.forEach(g => addPromoChoiceGroup(g));
                        // Load Supplements
                        if(d.supplements) d.supplements.forEach(s => addPromoSupplementRow(s));
                    }
                });
            }
        };

        // 6. OVERWRITE: Save Promo (to save data)
        window.savePromo = async () => {
            const btn = document.getElementById('btn-save-promo');
            btn.innerText = "Sauvegarde...";
            btn.disabled = true;
            
            try {
                const id = document.getElementById('edit-promo-id').value;
                const fileInput = document.getElementById('promo-image-file');
                let imageUrl = document.getElementById('promo-image-url').value;
                
                if (fileInput.files.length > 0) imageUrl = await uploadToCloudinary(fileInput.files[0]);
                
                const data = {
                    name: document.getElementById('promo-name').value,
                    price: parseFloat(document.getElementById('promo-price').value) || 0,
                    description: document.getElementById('promo-desc').value,
                    imageUrl: imageUrl,
                    isVisible: document.getElementById('promo-visible').checked,
                    mandatoryChoices: [],
                    supplements: []
                };

                // Collect Choices
                const choicesContainer = document.getElementById('promo-container-choices');
                choicesContainer.querySelectorAll('.group-row').forEach(g => {
                    const title = g.querySelector('.g-title').value;
                    const type = g.querySelector('.g-type').value;
                    const min = parseInt(g.querySelector('.g-min').value) || 0;
                    const max = parseInt(g.querySelector('.g-max').value) || 0;
                    const options = [];
                    g.querySelectorAll('.option-row').forEach(r => {
                        const name = r.querySelector('.opt-name').value;
                        const price = parseFloat(r.querySelector('.opt-price').value) || 0;
                        if(name) options.push({name, price});
                    });
                    if(title && options.length > 0) data.mandatoryChoices.push({title, type, options, min, max});
                });

                // Collect Supplements
                const suppContainer = document.getElementById('promo-container-supplements');
                suppContainer.querySelectorAll('.supp-row').forEach(r => {
                    const name = r.querySelector('.supp-name').value;
                    const price = parseFloat(r.querySelector('.supp-price').value) || 0;
                    if(name) data.supplements.push({name, price});
                });

                if (id) await updateDoc(doc(db, 'promotions', id), data);
                else await addDoc(collection(db, 'promotions'), data);
                
                closePromoEditor();
                loadPromotions();
            } catch(e) {
                console.error(e);
                alert("Erreur lors de la sauvegarde.");
            } finally {
                btn.innerText = "Sauvegarder Promo";
                btn.disabled = false;
            }
        };
    // --- CATEGORY EDITOR LOGIC ---

    window.openCategoryEditor = (id = null) => {
        const modal = document.getElementById('category-editor-modal');
        const form = document.getElementById('category-form');
        const title = document.getElementById('cat-editor-title');
        const btn = document.getElementById('btn-save-cat');
        
        // Reset form
        form.reset();
        document.getElementById('cat-image-preview').innerHTML = '<i data-feather="image" class="w-6 h-6 text-slate-300"></i>';
        
        // Show modal
        modal.classList.remove('hidden');
        setTimeout(() => modal.lastElementChild.classList.remove('translate-x-full'), 10);
        
        if (id) {
            // Edit Mode
            const cat = categories.find(c => c.id === id);
            if (cat) {
                document.getElementById('cat-id').value = cat.id;
                document.getElementById('cat-name').value = cat.name;
                if (cat.image) {
                    document.getElementById('cat-image-preview').innerHTML = `<img src="${cat.image}" class="w-full h-full object-cover">`;
                }
                title.innerText = "Modifier Catégorie";
                btn.innerText = "Mettre à jour";
            }
        } else {
            // New Mode
            document.getElementById('cat-id').value = '';
            title.innerText = "Nouvelle Catégorie";
            btn.innerText = "Créer";
        }
        feather.replace();
    };

    window.closeCategoryEditor = () => {
        const modal = document.getElementById('category-editor-modal');
        modal.lastElementChild.classList.add('translate-x-full');
        setTimeout(() => modal.classList.add('hidden'), 300);
    };

    // Override the existing editCategory function to use the new modal
    window.editCategory = (id) => {
        window.openCategoryEditor(id);
    };

    // --- UPDATED SAVE HANDLER (REPLACE YOUR OLD EVENT LISTENER) ---
    // Note: Remove your old "document.getElementById('category-form').addEventListener..." block before adding this one to avoid duplicates.
    
    const catForm = document.getElementById('category-form');
    // Remove old listener if possible, or just ensure this one runs last
    catForm.replaceWith(catForm.cloneNode(true)); 
    
    document.getElementById('category-form').addEventListener('submit', async e => {
        e.preventDefault();
        const btn = document.getElementById('btn-save-cat');
        btn.disabled = true;
        btn.innerText = "Sauvegarde...";
        
        try {
            const id = document.getElementById('cat-id').value;
            const name = document.getElementById('cat-name').value;
            const fileInput = document.getElementById('cat-image-file');
            
            let imageUrl = null;
            if (fileInput.files.length > 0) {
                // Assuming uploadToCloudinary is defined in your main script
                imageUrl = await uploadToCloudinary(fileInput.files[0]);
            }
            
            const data = { name };
            if (imageUrl) data.image = imageUrl;
            
            if (id) {
                await updateDoc(doc(db, 'categories', id), data);
            } else {
                data.order = categories.length; // Add to end
                await addDoc(collection(db, 'categories'), data);
            }
            
            closeCategoryEditor();
            loadCategories(); // Reload list
            
        } catch(e) {
            console.error(e);
            alert('Erreur lors de la sauvegarde');
        } finally {
            btn.disabled = false;
            btn.innerText = "Enregistrer";
        }
    });
    // --- 1. NEW HELPER FUNCTION ---
    // Toggles the visibility of the Min/Max inputs based on selection
    window.toggleMinMax = (selectElement) => {
        // We find the parent grid container, then look for the Min/Max div inside it
        const gridRow = selectElement.closest('.grid');
        const minMaxDiv = gridRow.querySelector('.min-max-area');
        
        if (selectElement.value === 'checkbox') {
            minMaxDiv.classList.remove('invisible');
        } else {
            minMaxDiv.classList.add('invisible');
            // Optional: Reset values to 0 when hidden
            minMaxDiv.querySelectorAll('input').forEach(i => i.value = 0);
        }
    };

    // --- 2. UPDATED ITEM CHOICE GROUP ---
    window.addChoiceGroup = (data = null) => {
        const div = document.createElement('div');
        div.className = "bg-slate-50 p-4 rounded-xl border border-slate-200 relative group-row animate-fade-in";
        
        // Logic to hide Min/Max by default unless it's a checkbox
        const isCheck = data?.type === 'checkbox';
        
        div.innerHTML = `
            <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-400 hover:text-red-600 p-1"><i data-feather="x" class="w-4 h-4"></i></button>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
                <div class="sm:col-span-1">
                    <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Titre</label>
                    <input type="text" class="g-title w-full p-2 border border-slate-200 rounded-lg text-sm font-bold" value="${data?.title||''}" placeholder="Ex: Taille">
                </div>
                <div class="sm:col-span-1">
                    <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Type</label>
                    <select class="g-type w-full p-2 border border-slate-200 rounded-lg text-sm bg-white" onchange="toggleMinMax(this)">
                        <option value="radio" ${data?.type==='radio'?'selected':''}>Unique (Radio)</option>
                        <option value="checkbox" ${isCheck?'selected':''}>Multiple (Check)</option>
                    </select>
                </div>
                <div class="sm:col-span-1 grid grid-cols-2 gap-2 min-max-area ${isCheck ? '' : 'invisible'}">
                    <div>
                        <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Min</label>
                        <input type="number" class="g-min w-full p-2 border border-slate-200 rounded-lg text-sm text-center" value="${data?.min||0}" min="0">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Max</label>
                        <input type="number" class="g-max w-full p-2 border border-slate-200 rounded-lg text-sm text-center" value="${data?.max||0}" min="0">
                    </div>
                </div>
            </div>
            <div class="g-options space-y-2 pl-3 border-l-2 border-slate-200"></div>
            <button type="button" onclick="addOptionRow(this)" class="mt-3 text-xs font-bold text-brand-600 hover:underline flex items-center gap-1">+ Choix</button>
        `;
        document.getElementById('container-choices').appendChild(div);
        
        const addBtn = div.querySelector('button[onclick^="addOptionRow"]');
        if(data?.options && data.options.length > 0) data.options.forEach(opt => addOptionRow(addBtn, opt)); 
        else addOptionRow(addBtn);
        feather.replace();
    };

    // --- 3. UPDATED PROMO CHOICE GROUP ---
    window.addPromoChoiceGroup = (data = null) => {
        const div = document.createElement('div');
        div.className = "bg-slate-50 p-4 rounded-xl border border-slate-200 relative group-row animate-fade-in";
        
        const isCheck = data?.type === 'checkbox';

        div.innerHTML = `
            <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-400 hover:text-red-600 p-1"><i data-feather="x" class="w-4 h-4"></i></button>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
                <div class="sm:col-span-1">
                    <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Titre</label>
                    <input type="text" class="g-title w-full p-2 border border-slate-200 rounded-lg text-sm font-bold" value="${data?.title||''}" placeholder="Ex: Choix Boisson">
                </div>
                <div class="sm:col-span-1">
                    <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Type</label>
                    <select class="g-type w-full p-2 border border-slate-200 rounded-lg text-sm bg-white" onchange="toggleMinMax(this)">
                        <option value="radio" ${data?.type==='radio'?'selected':''}>Unique (Radio)</option>
                        <option value="checkbox" ${isCheck?'selected':''}>Multiple (Check)</option>
                    </select>
                </div>
                <div class="sm:col-span-1 grid grid-cols-2 gap-2 min-max-area ${isCheck ? '' : 'invisible'}">
                    <div>
                        <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Min</label>
                        <input type="number" class="g-min w-full p-2 border border-slate-200 rounded-lg text-sm text-center" value="${data?.min||0}" min="0">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Max</label>
                        <input type="number" class="g-max w-full p-2 border border-slate-200 rounded-lg text-sm text-center" value="${data?.max||0}" min="0">
                    </div>
                </div>
            </div>
            <div class="g-options space-y-2 pl-3 border-l-2 border-slate-200"></div>
            <button type="button" onclick="addPromoOptionRow(this)" class="mt-3 text-xs font-bold text-brand-600 hover:underline flex items-center gap-1">+ Choix</button>
        `;
        document.getElementById('promo-container-choices').appendChild(div);
        
        const addBtn = div.querySelector('button[onclick^="addPromoOptionRow"]');
        if(data?.options && data.options.length > 0) {
            data.options.forEach(opt => addPromoOptionRow(addBtn, opt));
        } else {
            addPromoOptionRow(addBtn);
        }
        feather.replace();
    };
    </script>
</body>
</html>